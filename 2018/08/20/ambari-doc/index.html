<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/blog/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/blog/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Ambari," />








  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=5.0.1" />






<meta name="description" content="Stacks and ServicesIntroductionAmbari支持Stack的概念，并且将服务组合在一个Stack定义中。通过堆栈的作用，Ambari有统一定义的安装接口，管理并监控一组服务，并且引入了Stacks+Servides来提供延伸。从Ambari2.3开始，还支持Extension的概念，并将自定义服务组合在一个Extension定义中。
Terminology


Ter">
<meta property="og:type" content="article">
<meta property="og:title" content="ambari_doc">
<meta property="og:url" content="http://baimoon.github.io/2018/08/20/ambari-doc/index.html">
<meta property="og:site_name" content="Baimoon's Note">
<meta property="og:description" content="Stacks and ServicesIntroductionAmbari支持Stack的概念，并且将服务组合在一个Stack定义中。通过堆栈的作用，Ambari有统一定义的安装接口，管理并监控一组服务，并且引入了Stacks+Servides来提供延伸。从Ambari2.3开始，还支持Extension的概念，并将自定义服务组合在一个Extension定义中。
Terminology


Ter">
<meta property="og:image" content="http://oaavtz33a.bkt.clouddn.com/Screen%20Shot%202016-03-01%20at%202.47.32%20PM.png">
<meta property="og:image" content="http://oaavtz33a.bkt.clouddn.com/Screen%20Shot%202016-03-02%20at%2012.39.49%20PM.png">
<meta property="og:image" content="http://oaavtz33a.bkt.clouddn.com/Screen%20Shot%202016-03-02%20at%2012.32.58%20PM.png">
<meta property="og:image" content="http://oaavtz33a.bkt.clouddn.com/Screen%20Shot%202016-03-08%20at%2012.46.40%20PM.png">
<meta property="og:updated_time" content="2018-08-30T08:58:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ambari_doc">
<meta name="twitter:description" content="Stacks and ServicesIntroductionAmbari支持Stack的概念，并且将服务组合在一个Stack定义中。通过堆栈的作用，Ambari有统一定义的安装接口，管理并监控一组服务，并且引入了Stacks+Servides来提供延伸。从Ambari2.3开始，还支持Extension的概念，并将自定义服务组合在一个Extension定义中。
Terminology


Ter">
<meta name="twitter:image" content="http://oaavtz33a.bkt.clouddn.com/Screen%20Shot%202016-03-01%20at%202.47.32%20PM.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://baimoon.github.io/2018/08/20/ambari-doc/"/>

  <title> ambari_doc | Baimoon's Note </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Baimoon's Note</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                ambari_doc
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-08-20T15:57:27+08:00" content="2018-08-20">
              2018-08-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/blog/categories/Ambari/" itemprop="url" rel="index">
                    <span itemprop="name">Ambari</span>
                  </a>
                </span>

                
                

              
            </span>
          

          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Stacks-and-Services"><a href="#Stacks-and-Services" class="headerlink" title="Stacks and Services"></a>Stacks and Services</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Ambari支持Stack的概念，并且将服务组合在一个Stack定义中。通过堆栈的作用，Ambari有统一定义的安装接口，管理并监控一组服务，并且引入了Stacks+Servides来提供延伸。<br>从Ambari2.3开始，还支持Extension的概念，并将自定义服务组合在一个Extension定义中。</p>
<h2 id="Terminology"><a href="#Terminology" class="headerlink" title="Terminology"></a>Terminology</h2><table>
<thead>
<tr>
<th style="text-align:left">Term</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Stack</td>
<td style="text-align:left">定义了一组服务，并且这些服务从这里获取软件包。一个Stack能够有一个或多个版本，并且每个版本可以是活跃/不活跃的。例如, Stack=”HDP-1.3.3”。</td>
</tr>
<tr>
<td style="text-align:left">Extension</td>
<td style="text-align:left">定义了一组自定义服务，这些自定义服务可以被添加到一个stack版本中。一个Extension能够有一个或多个版本。</td>
</tr>
<tr>
<td style="text-align:left">Service</td>
<td style="text-align:left">定义Components（MASTER、SLAVE、CLIENT）组成了Service。如，Service=”HDFS”。</td>
</tr>
<tr>
<td style="text-align:left">Component</td>
<td style="text-align:left">每个Component遵循确切的生命周期（start、stop、install等）。例如：Service=”HDFS”包含的组件有：”NameNode(MASTER)”、”Secondary NameNode(MASTER)”、”DataNode(SLAVE)”和”HDFS Client(CLIENT)”</td>
</tr>
</tbody>
</table>
<h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Stack的定义可以在源码结构的/ambari-server/src/main/resources/stacks中找到。在你安装了Ambari服务之后，Stack的定义可以在/var/lib/ambari-server/resources/stacks中找到。</p>
<h2 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h2><p>Stack定义的结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">|_ stacks</div><div class="line">   |_ &lt;stack_name&gt;</div><div class="line">      |_ &lt;stack_version&gt;</div><div class="line">         metainfo.xml</div><div class="line">         |_ hooks</div><div class="line">         |_ repos</div><div class="line">            repoinfo.xml</div><div class="line">         |_ services</div><div class="line">            |_ &lt;service_name&gt;</div><div class="line">               metainfo.xml</div><div class="line">               metrics.json</div><div class="line">               |_ configuration</div><div class="line">                  &#123;configuration files&#125;</div><div class="line">               |_ package</div><div class="line">                  &#123;files, scripts, templates&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Defining-a-Service-and-Components"><a href="#Defining-a-Service-and-Components" class="headerlink" title="Defining a Service and Components"></a>Defining a Service and Components</h2><p>Service中的metainfo.xml描述了这个service、这个service的Components以及管理执行命令的脚本。服务的一个组件只能是MASTER、SLAVE或CLIENT三种类型中的一个。组件的类型用来告诉Ambari管理和监控这个组件的默认脚本。<br>对于每个Component，<commandscript>用来指从合适执行脚本。这个Component必须支持的一组默认命令。</commandscript></p>
<p>| Component Category | Default Lifecycle Commands |<br>| MASTER             | install, start, stop, configure, status |<br>| SLAVE              | install, start, stop, configure, status |<br>| CLIENT             | install, configure, status |</p>
<p>Ambari支持用PYTHON写的不同命令。类型用来知道如何执行命令脚本。如果你的Component需要支持多于默认生命周期的命令，你也能够创建自定义命令。<br>例如，下面的metainfo.xml在YARN服务描述了ResourceManager组件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;component&gt;</div><div class="line">  &lt;name&gt;RESOURCEMANAGER&lt;/name&gt;</div><div class="line">  &lt;category&gt;MASTER&lt;/category&gt;</div><div class="line">  &lt;commandScript&gt;</div><div class="line">    &lt;script&gt;scripts/resourcemanager.py&lt;/script&gt;</div><div class="line">    &lt;scriptType&gt;PYTHON&lt;/scriptType&gt;</div><div class="line">    &lt;timeout&gt;600&lt;/timeout&gt;</div><div class="line">  &lt;/commandScript&gt;</div><div class="line">  &lt;customCommands&gt;</div><div class="line">    &lt;customCommand&gt;</div><div class="line">      &lt;name&gt;DECOMMISSION&lt;/name&gt;</div><div class="line">      &lt;commandScript&gt;</div><div class="line">        &lt;script&gt;scripts/resourcemanager.py&lt;/script&gt;</div><div class="line">        &lt;scriptType&gt;PYTHON&lt;/scriptType&gt;</div><div class="line">        &lt;timeout&gt;600&lt;/timeout&gt;</div><div class="line">      &lt;/commandScript&gt;</div><div class="line">    &lt;/customCommand&gt;</div><div class="line">  &lt;/customCommands&gt;</div><div class="line">&lt;/component&gt;</div></pre></td></tr></table></figure></p>
<p>ResourceManager是一个MASTER组件，这个命令脚本为scripts/resourcemanager.py，这个脚本可以在services/YARN/package目录中找到。这个脚本是使用PYTHON写的，并且这个以python方法的方式实现了默认的生命周期命令。下面是install方法，对应的是默认的INSTALL命令：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Resourcemanager</span><span class="params">(Script)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self, env)</span>:</span></div><div class="line">    self.install_packages(env)</div><div class="line">    self.configure(env)</div></pre></td></tr></table></figure></p>
<p>你还可以看到有一个自定义命令DECOMMISSION，这意味着在python命令脚本中还有一个decommission方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decommission</span><span class="params">(self, env)</span>:</span></div><div class="line">  <span class="keyword">import</span> params</div><div class="line"> </div><div class="line">  ...</div><div class="line"> </div><div class="line">  Execute(yarn_refresh_cmd,</div><div class="line">          user=yarn_user</div><div class="line">  )</div><div class="line">  <span class="keyword">pass</span></div></pre></td></tr></table></figure></p>
<h2 id="Using-Stack-Inheritance"><a href="#Using-Stack-Inheritance" class="headerlink" title="Using Stack Inheritance"></a>Using Stack Inheritance</h2><p>Stacks能够从其他Stack进行继承，以便共享命令脚本和配置。通过如下方式降低了代码的重复：</p>
<blockquote>
<p>为子Stack定义了repositories。<br>在子Stack中添加新的Service（不是在父Stack中）。<br>重写父级Services的命令脚本。<br>重写父级Services的配置。</p>
</blockquote>
<p>例如：HDP 2.1 Stack继承了HDP 2.0.6 Stack，因此只需要在Stack定义中对HDP 2.1 Stack中适当的修改。这个extension在metainfo.xml中对HDP 2.1 Stack进行定义。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">metainfo</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">versions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">active</span>&gt;</span>true<span class="tag">&lt;/<span class="name">active</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">versions</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">extends</span>&gt;</span>2.0.6<span class="tag">&lt;/<span class="name">extends</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">metainfo</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="Example-Implementing-a-Custom-Service"><a href="#Example-Implementing-a-Custom-Service" class="headerlink" title="Example: Implementing a Custom Service"></a>Example: Implementing a Custom Service</h2><p>在这个例子中，我们将创建一个名为”SAMPLESRV”的自定义service，并将它添加到已有的Stack定义中。这个service含有 MASTER、SLAVE和CLIENT组件。</p>
<h3 id="Create-and-Add-the-Service"><a href="#Create-and-Add-the-Service" class="headerlink" title="Create and Add the Service"></a>Create and Add the Service</h3><p>1、在Ambari server上，跳转到/var/lib/ambari-server/resources/stacks/HDP/2.0.6/services目录。在这个例子中，我们将浏览到HDP 2.0 stack定义。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services</div></pre></td></tr></table></figure></p>
<p>2、创建一个目录：/var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/SAMPLESRV。它用来包含SAMPLESEV的service的定义。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/SAMPLESRV</div><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/SAMPLESRV</div></pre></td></tr></table></figure></p>
<p>3、跳转到新创建的SAMPLESRV目录，创建metainfo.xml文件，这个文件用来描述新的service。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</div><div class="line">&lt;metainfo&gt;</div><div class="line">    &lt;schemaVersion&gt;2.0&lt;/schemaVersion&gt;</div><div class="line">    &lt;services&gt;</div><div class="line">        &lt;service&gt;</div><div class="line">            &lt;name&gt;SAMPLESRV&lt;/name&gt;</div><div class="line">            &lt;displayName&gt;New Sample Service&lt;/displayName&gt;</div><div class="line">            &lt;comment&gt;A New Sample Service&lt;/comment&gt;</div><div class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</div><div class="line">            &lt;components&gt;</div><div class="line">                &lt;component&gt;</div><div class="line">                    &lt;name&gt;SAMPLESRV_MASTER&lt;/name&gt;</div><div class="line">                    &lt;displayName&gt;Sample Srv Master&lt;/displayName&gt;</div><div class="line">                    &lt;category&gt;MASTER&lt;/category&gt;</div><div class="line">                    &lt;cardinality&gt;1&lt;/cardinality&gt;</div><div class="line">                    &lt;commandScript&gt;</div><div class="line">                        &lt;script&gt;scripts/master.py&lt;/script&gt;</div><div class="line">                        &lt;scriptType&gt;PYTHON&lt;/scriptType&gt;</div><div class="line">                        &lt;timeout&gt;600&lt;/timeout&gt;</div><div class="line">                    &lt;/commandScript&gt;</div><div class="line">                &lt;/component&gt;</div><div class="line">                &lt;component&gt;</div><div class="line">                    &lt;name&gt;SAMPLESRV_SLAVE&lt;/name&gt;</div><div class="line">                    &lt;displayName&gt;Sample Srv Slave&lt;/displayName&gt;</div><div class="line">                    &lt;category&gt;SLAVE&lt;/category&gt;</div><div class="line">                    &lt;cardinality&gt;1+&lt;/cardinality&gt;</div><div class="line">                    &lt;commandScript&gt;</div><div class="line">                        &lt;script&gt;scripts/slave.py&lt;/script&gt;</div><div class="line">                        &lt;scriptType&gt;PYTHON&lt;/scriptType&gt;</div><div class="line">                        &lt;timeout&gt;600&lt;/timeout&gt;</div><div class="line">                    &lt;/commandScript&gt;</div><div class="line">                &lt;/component&gt;</div><div class="line">                &lt;component&gt;</div><div class="line">                    &lt;name&gt;SAMPLESRV_CLIENT&lt;/name&gt;</div><div class="line">                    &lt;displayName&gt;Sample Srv Client&lt;/displayName&gt;</div><div class="line">                    &lt;category&gt;CLIENT&lt;/category&gt;</div><div class="line">                    &lt;cardinality&gt;1+&lt;/cardinality&gt;</div><div class="line">                    &lt;commandScript&gt;</div><div class="line">                        &lt;script&gt;scripts/sample_client.py&lt;/script&gt;</div><div class="line">                        &lt;scriptType&gt;PYTHON&lt;/scriptType&gt;</div><div class="line">                        &lt;timeout&gt;600&lt;/timeout&gt;</div><div class="line">                    &lt;/commandScript&gt;</div><div class="line">                &lt;/component&gt;</div><div class="line">            &lt;/components&gt;</div><div class="line">            &lt;osSpecifics&gt;</div><div class="line">                &lt;osSpecific&gt;</div><div class="line">                    &lt;osFamily&gt;any&lt;/osFamily&gt;  &lt;!-- note: use osType rather than osFamily for Ambari 1.5.0 and 1.5.1 --&gt;</div><div class="line">                &lt;/osSpecific&gt;</div><div class="line">            &lt;/osSpecifics&gt;</div><div class="line">        &lt;/service&gt;</div><div class="line">    &lt;/services&gt;</div><div class="line">&lt;/metainfo&gt;</div></pre></td></tr></table></figure></p>
<p>4、在上面，我们的service名为“SAMPLESRV”，它包含：</p>
<blockquote>
<p>一个名为”SAMPLESRV_MASTER”的MASTER的组件。<br>一个名为“SLAVE”的SLAVE的组件。<br>一个名为“CLIENT”的CLIENT的组件。</p>
</blockquote>
<p>5、接下来，创建命令脚本。为脚本创建目录/var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/SAMPLESRV/package/scripts，并在这个目录中定义service的metainfo。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/SAMPLESRV/package/scripts</div><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/SAMPLESRV/package/scripts</div></pre></td></tr></table></figure></p>
<p>跳转到script目录，并创建.py命令脚本文件。<br>master.py文件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> resource_management <span class="keyword">import</span> *</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Master</span><span class="params">(Script)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Install the Sample Srv Master'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Stop the Sample Srv Master'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Start the Sample Srv Master'</span>;</div><div class="line">     </div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">status</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Status of the Sample Srv Master'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">configure</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Configure the Sample Srv Master'</span>;</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  Master().execute()</div></pre></td></tr></table></figure></p>
<p>slave.py文件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> resource_management <span class="keyword">import</span> *</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Slave</span><span class="params">(Script)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Install the Sample Srv Slave'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Stop the Sample Srv Slave'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Start the Sample Srv Slave'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">status</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Status of the Sample Srv Slave'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">configure</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Configure the Sample Srv Slave'</span>;</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  Slave().execute()</div></pre></td></tr></table></figure></p>
<p>sample_client.py文件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> resource_management <span class="keyword">import</span> *</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SampleClient</span><span class="params">(Script)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Install the Sample Srv Client'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">configure</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Configure the Sample Srv Client'</span>;</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  SampleClient().execute()</div></pre></td></tr></table></figure></p>
<p>7、现在重启Ambari Server以便新的service定义分发到集群的所有Agents。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ambari-server restart</div></pre></td></tr></table></figure></p>
<h3 id="Install-the-Service-Via-Ambari-WEb-“Add-Service”"><a href="#Install-the-Service-Via-Ambari-WEb-“Add-Service”" class="headerlink" title="Install the Service(Via Ambari WEb “Add Service”)"></a>Install the Service(Via Ambari WEb “Add Service”)</h3><p>从Ambari 1.7.0开始，可以通过Ambari Web来添加自定义服务。</p>
<blockquote>
<p>在Ambari web页面，跳转到services，并点击左边service导航部分的Action按钮。<br>点击“Add Services”。你将看到一个包含“My Sample Service”（在metainfo.xml文件中定义service的<displayname>）的选项。<br>选择“My Sample service”并点击下一步。<br>选择“Sample Srv Master”并点击下一步。<br>选择host来安装”Sample Srv Client”，并点击下一步。<br>一旦完成，”My Sample Service”将会在在service导航区可用。<br>如果你想要为所有host添加“Sample Srv Client”，你可以跳转到Host，并到航道指定的host并点击”+ Add”。</displayname></p>
</blockquote>
<h2 id="Example-Implementing-a-Custom-Client-only-Service"><a href="#Example-Implementing-a-Custom-Client-only-Service" class="headerlink" title="Example: Implementing a Custom Client-only Service"></a>Example: Implementing a Custom Client-only Service</h2><p>在这个例子中，我们将创建一个名为“TESTSRV”的自定义service，添加到已经存在的Stack定义上，并Ambari APIs来安装/配置这个service。这个service是一个CLIENT，因此它有两个命令：install和configure。</p>
<h3 id="Create-and-Add-the-Service-1"><a href="#Create-and-Add-the-Service-1" class="headerlink" title="Create and Add the Service"></a>Create and Add the Service</h3><p>1、在Ambari Service上，跳转到 /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services目录。在这个例子中，我们将跳转到HDP2.0 Stack 定义中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services</div></pre></td></tr></table></figure></p>
<p>2、创建一个名为/var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTSRV的目录，它用来包含TESTSRV的service定义。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTSRV</div><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTSRV</div></pre></td></tr></table></figure></p>
<p>3、跳转到新创建的TESTSRV目录，创建一个名为metainfo.xml的文件用来描述新的service。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</div><div class="line">&lt;metainfo&gt;</div><div class="line">    &lt;schemaVersion&gt;2.0&lt;/schemaVersion&gt;</div><div class="line">    &lt;services&gt;</div><div class="line">        &lt;service&gt;</div><div class="line">            &lt;name&gt;TESTSRV&lt;/name&gt;</div><div class="line">            &lt;displayName&gt;New Test Service&lt;/displayName&gt;</div><div class="line">            &lt;comment&gt;A New Test Service&lt;/comment&gt;</div><div class="line">            &lt;version&gt;0.1.0&lt;/version&gt;</div><div class="line">            &lt;components&gt;</div><div class="line">                &lt;component&gt;</div><div class="line">                    &lt;name&gt;TEST_CLIENT&lt;/name&gt;</div><div class="line">                    &lt;displayName&gt;New Test Client&lt;/displayName&gt;</div><div class="line">                    &lt;category&gt;CLIENT&lt;/category&gt;</div><div class="line">                    &lt;cardinality&gt;1+&lt;/cardinality&gt;</div><div class="line">                    &lt;commandScript&gt;</div><div class="line">                        &lt;script&gt;scripts/test_client.py&lt;/script&gt;</div><div class="line">                        &lt;scriptType&gt;PYTHON&lt;/scriptType&gt;</div><div class="line">                        &lt;timeout&gt;600&lt;/timeout&gt;</div><div class="line">                    &lt;/commandScript&gt;</div><div class="line">                    &lt;customCommands&gt;</div><div class="line">                      &lt;customCommand&gt;</div><div class="line">                        &lt;name&gt;SOMETHINGCUSTOM&lt;/name&gt;</div><div class="line">                        &lt;commandScript&gt;</div><div class="line">                          &lt;script&gt;scripts/test_client.py&lt;/script&gt;</div><div class="line">                          &lt;scriptType&gt;PYTHON&lt;/scriptType&gt;</div><div class="line">                          &lt;timeout&gt;600&lt;/timeout&gt;</div><div class="line">                        &lt;/commandScript&gt;</div><div class="line">                      &lt;/customCommand&gt;</div><div class="line">                    &lt;/customCommands&gt;</div><div class="line">                &lt;/component&gt;</div><div class="line">            &lt;/components&gt;</div><div class="line">            &lt;osSpecifics&gt;</div><div class="line">                &lt;osSpecific&gt;</div><div class="line">                    &lt;osFamily&gt;any&lt;/osFamily&gt;  &lt;!-- note: use osType rather than osFamily for Ambari 1.5.0 and 1.5.1 --&gt;</div><div class="line">                &lt;/osSpecific&gt;</div><div class="line">            &lt;/osSpecifics&gt;</div><div class="line">        &lt;/service&gt;</div><div class="line">    &lt;/services&gt;</div><div class="line">&lt;/metainfo&gt;</div></pre></td></tr></table></figure></p>
<p>4、在上面，我们的service名为“TESTSRV”，并且它包含了一个名为“TEST_CLIENT”的组件，这个组件属于CLIENT类型。这个client通过命令脚本scripts/test_client.py来管理。接下来创建命令脚本。<br>5、为命令脚本创建目录/var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTSRV/package/scripts。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTSRV/package/scripts</div><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTSRV/package/scripts</div></pre></td></tr></table></figure></p>
<p>6、跳转到scripts目录，并创建test_client.py文件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> resource_management <span class="keyword">import</span> *</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestClient</span><span class="params">(Script)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Install the client'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">configure</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Configure the client'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">somethingcustom</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Something custom'</span>;</div><div class="line"> </div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  TestClient().execute()</div></pre></td></tr></table></figure></p>
<p>7、现在，重启Ambari Server，将新的service定义分发到集群的所有Agents。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ambari-server restart</div></pre></td></tr></table></figure></p>
<h3 id="Install-the-Service-Via-the-Ambari-REST-API"><a href="#Install-the-Service-Via-the-Ambari-REST-API" class="headerlink" title="Install the Service(Via the Ambari REST API)"></a>Install the Service(Via the Ambari REST API)</h3><p>1、将Service添加到Cluster。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">POST</div><div class="line">/api/v1/clusters/MyCluster/services</div><div class="line"> </div><div class="line">&#123;</div><div class="line">&quot;ServiceInfo&quot;: &#123;</div><div class="line">  &quot;service_name&quot;:&quot;TESTSRV&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>2、添加组件到Service。这个例子中，添加TEST_CLIENT到TESTSRV。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">POST</div><div class="line">/api/v1/clusters/MyCluster/services/TESTSRV/components/TEST_CLIENT</div></pre></td></tr></table></figure></p>
<p>3、将组件添加到所有host。例如，要安装到c6402.ambari.apache.org和c6403.ambari.apache.org上，首先使用POST在这些主机上创建host_component源<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">POST</div><div class="line">/api/v1/clusters/MyCluster/hosts/c6402.ambari.apache.org/host_components/TEST_CLIENT</div><div class="line"> </div><div class="line">POST</div><div class="line">/api/v1/clusters/MyCluster/hosts/c6403.ambari.apache.org/host_components/TEST_CLIENT</div></pre></td></tr></table></figure></p>
<p>4、现在，需要在所有主机上安装组件。在这个命令中，你指导Ambari来安装与这个service有关的所有组件。调用每个主机上命令脚本的install方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">PUT</div><div class="line">/api/v1/clusters/MyCluster/services/TESTSRV</div><div class="line"> </div><div class="line">&#123;</div><div class="line">  &quot;RequestInfo&quot;: &#123;</div><div class="line">    &quot;context&quot;: &quot;Install Test Srv Client&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;Body&quot;: &#123;</div><div class="line">    &quot;ServiceInfo&quot;: &#123;</div><div class="line">      &quot;state&quot;: &quot;INSTALLED&quot;</div><div class="line">    &#125;   </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>除了同时安装所有的组件，你还可以只在某一台机器上装组件。在这个例子中，我们在c6402.ambari.apache.org上安装TEST_CLIENT：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">PUT</div><div class="line">/api/v1/clusters/MyCluster/hosts/c6402.ambari.apache.org/host_components/TEST_CLIENT</div><div class="line"> </div><div class="line">&#123;</div><div class="line">  &quot;RequestInfo&quot;: &#123;</div><div class="line">    &quot;context&quot;:&quot;Install Test Srv Client&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;Body&quot;: &#123;</div><div class="line">    &quot;HostRoles&quot;: &#123;</div><div class="line">      &quot;state&quot;:&quot;INSTALLED&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>6、使用如下信息配置主机上的client。这将最终调用命令脚本中的configure()方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">POST</div><div class="line">/api/v1/clusters/MyCluster/requests</div><div class="line">  </div><div class="line">&#123;</div><div class="line">  &quot;RequestInfo&quot; : &#123;</div><div class="line">    &quot;command&quot; : &quot;CONFIGURE&quot;,</div><div class="line">    &quot;context&quot; : &quot;Config Test Srv Client&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;Requests/resource_filters&quot;: [&#123;</div><div class="line">    &quot;service_name&quot; : &quot;TESTSRV&quot;,</div><div class="line">    &quot;component_name&quot; : &quot;TEST_CLIENT&quot;,</div><div class="line">    &quot;hosts&quot; : &quot;c6403.ambari.apache.org&quot;</div><div class="line">  &#125;]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>7、如果你想看哪些主机完成了安装。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GET</div><div class="line">/api/v1/clusters/MyCluster/components/TEST_CLIENT</div></pre></td></tr></table></figure></p>
<h3 id="Install-the-Service-via-Ambari-Web-“Add-Services”"><a href="#Install-the-Service-via-Ambari-Web-“Add-Services”" class="headerlink" title="Install the Service(via Ambari Web “Add Services”)"></a>Install the Service(via Ambari Web “Add Services”)</h3><blockquote>
<p>1、在Ambari Web界面，跳转到Services并点击左侧Service导航区的Actions按钮。<br>2、点击“Add Services”。你将看到一个“My Test Service”的选项（在service的metainfo.xml文件中services的<displayname>中定义）。<br>3、选择“My Test Service”并点击下一步。<br>4、选择主机来安装“New Test Client”并点击下一步。<br>5、一旦完成，“My Test Service”将在Service导航区中可用。<br>6、如果你想要在其他主机上添加“New Test Client”，你可以跳转到Hosts，并指定主机后点击“+ Add”。</displayname></p>
</blockquote>
<h2 id="Example-Implementing-a-Custom-Client-only-Service-with-Configs"><a href="#Example-Implementing-a-Custom-Client-only-Service-with-Configs" class="headerlink" title="Example: Implementing a Custom Client-only Service (with Configs)"></a>Example: Implementing a Custom Client-only Service (with Configs)</h2><p>在这个例子中，我们将创建一个名为“TESTCONFIGSRV”的自定义service，并将其添加到已有的Stack定义上。这个service是一个CLIENT类型，因此它有两个命令：install和configure。service还包含”test-confg”配置类型。</p>
<h3 id="Create-and-Add-the-Service-to-Stack"><a href="#Create-and-Add-the-Service-to-Stack" class="headerlink" title="Create and Add the Service to Stack"></a>Create and Add the Service to Stack</h3><p>1、在Ambari Server上，跳转到/var/lib/ambari-server/resources/stacks/HDP/2.0.6/services目录。在这个例子中，我们将跳转到HDP 2.0 Stack定义。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services</div></pre></td></tr></table></figure></p>
<p>2、创建名为/var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTCONFIGSRV的目录，它包含了为TESTCONFIGSRV定义的service。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTCONFIGSRV</div><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTCONFIGSRV</div></pre></td></tr></table></figure></p>
<p>3、跳转到刚刚创建的TESTCONFIGSRV目录，创建一个metainfo.xml文件，这个文件描述了这个新的service。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</div><div class="line">&lt;metainfo&gt;</div><div class="line">    &lt;schemaVersion&gt;2.0&lt;/schemaVersion&gt;</div><div class="line">    &lt;services&gt;</div><div class="line">        &lt;service&gt;</div><div class="line">            &lt;name&gt;TESTCONFIGSRV&lt;/name&gt;</div><div class="line">            &lt;displayName&gt;New Test Config Service&lt;/displayName&gt;</div><div class="line">            &lt;comment&gt;A New Test Config Service&lt;/comment&gt;</div><div class="line">            &lt;version&gt;0.1.0&lt;/version&gt;</div><div class="line">            &lt;components&gt;</div><div class="line">                &lt;component&gt;</div><div class="line">                    &lt;name&gt;TESTCONFIG_CLIENT&lt;/name&gt;</div><div class="line">                    &lt;displayName&gt;New Test Config Client&lt;/displayName&gt;</div><div class="line">                    &lt;category&gt;CLIENT&lt;/category&gt;</div><div class="line">                    &lt;cardinality&gt;1+&lt;/cardinality&gt;</div><div class="line">                    &lt;commandScript&gt;</div><div class="line">                        &lt;script&gt;scripts/test_client.py&lt;/script&gt;</div><div class="line">                        &lt;scriptType&gt;PYTHON&lt;/scriptType&gt;</div><div class="line">                        &lt;timeout&gt;600&lt;/timeout&gt;</div><div class="line">                    &lt;/commandScript&gt;</div><div class="line">                &lt;/component&gt;</div><div class="line">            &lt;/components&gt;</div><div class="line">            &lt;osSpecifics&gt;</div><div class="line">                &lt;osSpecific&gt;</div><div class="line">                    &lt;osFamily&gt;any&lt;/osFamily&gt;  &lt;!-- note: use osType rather than osFamily for Ambari 1.5.0 and 1.5.1 --&gt;</div><div class="line">                &lt;/osSpecific&gt;</div><div class="line">            &lt;/osSpecifics&gt;</div><div class="line">        &lt;/service&gt;</div><div class="line">    &lt;/services&gt;</div><div class="line">&lt;/metainfo&gt;</div></pre></td></tr></table></figure></p>
<p>4、在上面，我的service的名为“TESTCONFIGSRV”，并且它包含一个名为“TESTCONFIG_CLIENT”组件，这个组件的类型为“CLINT”。这个client通过命令脚本scripts/test_client.py来管理。接下来创建这个命令脚本。<br>5、为命令脚本创建目录/var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTCONFIGSRV/package/scripts，这个脚本在ervice metainfo <commandscript>中指定。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTCONFIGSRV/package/scripts</div><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTCONFIGSRV/package/scripts</div></pre></td></tr></table></figure></commandscript></p>
<p>6、调转到scripts目录，并创建test_client.py文件。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">import sys</div><div class="line">from resource_management import *</div><div class="line"> </div><div class="line">class TestClient(Script):</div><div class="line">  def install(self, env):</div><div class="line">    print &apos;Install the config client&apos;;</div><div class="line">  def configure(self, env):</div><div class="line">    print &apos;Configure the config client&apos;;</div><div class="line"> </div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">  TestClient().execute()</div></pre></td></tr></table></figure></p>
<p>7、现在，为这个service定义配置类型。为配置目录/var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTCONFIGSRV/configuration创建一个目录。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTCONFIGSRV/configuration</div><div class="line">cd /var/lib/ambari-server/resources/stacks/HDP/2.0.6/services/TESTCONFIGSRV/configuration</div></pre></td></tr></table></figure></p>
<p>8、跳转到配置目录，并创建test-config.xml文件。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</div><div class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</div><div class="line"> </div><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;some.test.property&lt;/name&gt;</div><div class="line">    &lt;value&gt;this.is.the.default.value&lt;/value&gt;</div><div class="line">    &lt;description&gt;This is a kool description.&lt;/description&gt;</div><div class="line"> &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure></p>
<p>9、现在，重启Ambari Server以便将service分发到集群中的所有Agent上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ambari-server restart</div></pre></td></tr></table></figure></p>
<h1 id="How-To-Define-Stacks-and-Services"><a href="#How-To-Define-Stacks-and-Services" class="headerlink" title="How-To Define  Stacks and Services"></a>How-To Define  Stacks and Services</h1><p>Ambari管理的Services在Ambari的stacks文件夹中定义。<br>要定义自己的services和stacks并被Ambari管理，请遵循如下步骤。<br>上面的create your custom stack and service的例子也可以学习。<br>stack是services的集合。一个stack可以定义多个版本，每个版本有自己的一组service。Ambari中的Stacks在 ambari-server/src/main/resources/stacks 文件夹中定义，这个文件夹可以在安装之后的/var/lib/ambari-server/resources/stacks目录找到。<br>被stack管理的servces能够在 ambari-server/src/main/resources/common-services 或 ambari-server/src/main/resources/stacks 文件夹中定义。这些文件对应安装后的目录分别为：/var/lib/ambari-server/resources/common-services 或  /var/lib/ambari-server/resources/stacks。</p>
<blockquote>
<p>Question : 什么时候在 common-services 或 stacks 文件夹中定义service呢<br>当service可能被用于多个stacks时，我们将在common-services文件夹中定义service。例如，几乎所有的stacks都需要HDFS service，因此将它定义在common-services而不是在每个stack中定义是值得推荐的。同样，如果一个service从不会被共享，它能够被定义在stack文件夹中。基本上来说stacks文件夹中定义services是不推荐的，而推荐将service定义在common-services中。</p>
</blockquote>
<h2 id="Define-Service"><a href="#Define-Service" class="headerlink" title="Define Service"></a>Define Service</h2><p>下面展示了如何在common-services文件夹中定义一个service。在stacks文件夹中定义services时，也可以使用相同的方法，具体会在定义stack章节介绍。</p>
<p><img src="http://oaavtz33a.bkt.clouddn.com/Screen%20Shot%202016-03-01%20at%202.47.32%20PM.png"></p>
<p>Services必须提供主要的metainfo.xml文件，它提供了关于这个service的重要元数据。<br>除此之外，其他文件提供了关于server的更多信息。关于这些文件的更多信息将在下面提供。</p>
<p>一个service也可能继承自它的之前版本或common services。关于继承的更多信息，请查看<a href="https://cwiki.apache.org/confluence/display/AMBARI/Service+Inheritance" title="Service Inheritance" target="_blank" rel="external">Service Inheritance</a>。</p>
<h2 id="metainfo-xml"><a href="#metainfo-xml" class="headerlink" title="metainfo.xml"></a>metainfo.xml</h2><p>在metainfo.xml服务描述符中，首先被定义的是service和它的components。<br>完整的参考文献可以在<a href="https://cwiki.apache.org/confluence/display/AMBARI/Writing+metainfo.xml" title="Writing metainfo.xml" target="_blank" rel="external">Writing metainfo.xml</a>中找到。<br>值得推荐的metainfo.xml实现是<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/metainfo.xml#L27" title="HDFS metainfo.xml" target="_blank" rel="external">HDFS metainfo.xml</a>。</p>
<blockquote>
<p>Question : 是否可以在同一个metainfo.xml中定义多个services？<br>可以。尽管可以，但是强烈拒绝在相同的service文件夹中定义多个services。<br>YARN和MapReduces2就被一起定义在YARN文件夹中。它的metainfo.xml同时定义了两个services。</p>
</blockquote>
<h3 id="Scripts"><a href="#Scripts" class="headerlink" title="Scripts"></a>Scripts</h3><p>对于components的定义，我们需要提供脚本来处理service的不同阶段以及组件的生命周期。<br>管理service和components的脚本在metainfo.xml(<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/metainfo.xml#L35" title="HDFS" target="_blank" rel="external">HDFS</a>)中指定。<br>每个脚本应该继承<a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-common/src/main/python/resource_management/libraries/script/script.py" title="Script" target="_blank" rel="external">Script</a>类，这个父类提供了有用的方法。例如：<a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts/namenode.py#L68" title="NameNode script" target="_blank" rel="external">NameNode script</a>。</p>
<p><img src="http://oaavtz33a.bkt.clouddn.com/Screen%20Shot%202016-03-02%20at%2012.39.49%20PM.png"><br>这些脚本应该在<service-id>/<service-version>/package/script文件夹中提供。<br><img src="http://oaavtz33a.bkt.clouddn.com/Screen%20Shot%202016-03-02%20at%2012.32.58%20PM.png"></service-version></service-id></p>
<table>
<thead>
<tr>
<th style="text-align:left">Folder</th>
<th style="text-align:left">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">package/script</td>
<td style="text-align:left">包含了由Ambari执行的脚本。这些脚本使用正确的环境被加载到执行路径中。例如：<a href="https://github.com/apache/ambari/tree/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts" title="HDFS" target="_blank" rel="external">HDFS</a></td>
</tr>
<tr>
<td style="text-align:left">package/files</td>
<td style="text-align:left">包含被上面脚本使用的文件。一般是其他一些作为独立进程执行的脚本（bash、python等）。例如：checkWebUI.py在HDFS检查中运行，用来确定Journal Node是否活跃。</td>
</tr>
<tr>
<td style="text-align:left">package/tmplates</td>
<td style="text-align:left">上述脚本在管理节点上生成的临时文件。一般是service需要操作的配置文件。例如：<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/templates/exclude_hosts_list.j2" title="exclude_hosts_list.j2" target="_blank" rel="external">exclude_hosts_list.j2</a> ，被脚本使用来产生/etc/hadoop/conf/dfs.exclude。</td>
</tr>
</tbody>
</table>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>Ambari默认支持python脚本来管理service和components。<br>component脚本应该继承resource_management.Script类并提供component的生命周期所需的方法。<br>参考<a href="https://cwiki.apache.org/confluence/display/AMBARI/Defining+a+Custom+Stack+and+Services" title="how to create custom stack" target="_blank" rel="external">how to create custom stack</a>页面，MASTER、SLAVE和CLIENT组件贯穿生命周期所需的方法如下：<br>master.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> resource_management <span class="keyword">import</span> Script</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Master</span><span class="params">(Script)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Install the Sample Srv Master'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Stop the Sample Srv Master'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Start the Sample Srv Master'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">status</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Status of the Sample Srv Master'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">configure</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Configure the Sample Srv Master'</span>;</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  Master().execute()</div></pre></td></tr></table></figure></p>
<p>slave.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> resource_management <span class="keyword">import</span> Script</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Slave</span><span class="params">(Script)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Install the Sample Srv Slave'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Stop the Sample Srv Slave'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Start the Sample Srv Slave'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">status</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Status of the Sample Srv Slave'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">configure</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Configure the Sample Srv Slave'</span>;</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  Slave().execute()</div></pre></td></tr></table></figure></p>
<p>client.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> resource_management <span class="keyword">import</span> Script</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SampleClient</span><span class="params">(Script)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Install the Sample Srv Client'</span>;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">configure</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Configure the Sample Srv Client'</span>;</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  SampleClient().execute()</div></pre></td></tr></table></figure></p>
<p>Ambari提供了有用的Python库，以便在以下方面提供写servier脚本的帮助。对于这些库的完整介绍，请通过<a href="https://cwiki.apache.org/confluence/display/AMBARI/Ambari+Python+Libraries" title="Ambari Python Libraries" target="_blank" rel="external">Ambari Python Libraries</a>页面访问。</p>
<blockquote>
<p>resource_management<br>ambari_commons<br>ambari_simplejson</p>
</blockquote>
<h4 id="OS-Variant-Script"><a href="#OS-Variant-Script" class="headerlink" title="OS Variant Script"></a>OS Variant Script</h4><p>如果service支持多个操作系统，则需要根据不同的操作系统由独立的脚本，可以继承resource_management.Script类并使用不同的@OSFamilyImpl()注解。<br>这能够区分组件的不同操作系统的方法。<br>例如： <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts/namenode.py#L126" title="NameNode default script" target="_blank" rel="external">NameNode default script</a>， <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts/namenode.py#L346" title="NameNode Windows script" target="_blank" rel="external">NameNode Windows script</a></p>
<blockquote>
<p>Examples<br>NameNode <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts/hdfs_namenode.py#L93" title="start" target="_blank" rel="external">Start</a>， <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts/hdfs_namenode.py#L208" title="Stop" target="_blank" rel="external">Stop</a><br>DataNode <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts/hdfs_datanode.py#L68" title="
Start and Stop" target="_blank" rel="external">Start and Stop</a><br>HDFS <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts/hdfs.py#L31" title="configurations persistence" target="_blank" rel="external">configurations persistence</a></p>
</blockquote>
<h3 id="Custom-Actions"><a href="#Custom-Actions" class="headerlink" title="Custom Actions"></a>Custom Actions</h3><p>有些时候，services需要执行一些行为，这些行为不同于Ambari提供的默认行为（install、start、stop、configure等）。<br>services能够定义一些action，并将这些action在UI中展示给用户，因此这些行为能够方便执行。<br>举例说明，如HDFS实现的Rebalance HDFS自定义行为。</p>
<h4 id="Stack-Changes"><a href="#Stack-Changes" class="headerlink" title="Stack Changes"></a>Stack Changes</h4><blockquote>
<p>1、在metainfo.xml中component的<a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/metainfo.xml#L49" title="Define custom command insid the customCommands section" target="_blank" rel="external"><customcommands>部分中定义指定义命令</customcommands></a>。<br>2、在metainfo.xml相关的脚本中，用相同的名字实现方法，来作为自定义命令。<br>    a）如果自定义命令不含有操作系统变量，它可以在同一个继承resource_management.Script的类中被实现。<br>    b）如果含有操作系统变量，每个类中的不同方法可以通过@OsFamilyImpl(os_family=…)来实现。<a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts/namenode.py#L273" title="Default rebalancehdfs" target="_blank" rel="external">Default rebalancehdfs</a>, <a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/package/scripts/namenode.py#L354" title="Windows rebalancehdfs" target="_blank" rel="external">Windows rebalancehdfs</a>。<br>这将提供在安装了service的被管理的主机上以后端方式运行脚本的能力。</p>
</blockquote>
<h4 id="UI-Changes"><a href="#UI-Changes" class="headerlink" title="UI Changes"></a>UI Changes</h4><p>在host页面上查看自定义action不需要修改UI。<br>action将展示在主机组件的action列表中。任何master-component action将自动展示在service的action菜单上。<br>当action被点击后，将自动产生POST调用来触发上面定义的脚本。</p>
<blockquote>
<p>Question ： 如何为UI中的自定义action提供自己的标签和图标？<br>在Ambari UI中，使用自定义图标和名称，添加你的component action到App.HostComponentActionMap对象。</p>
</blockquote>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>service的配置文件应当位于默认的configuration文件夹中。<br>如果使用了不同的文件夹，metainfo.xml中的<configuration-dir>，可以用来指明使用的文件夹。<br>metainfo.xml中需要考虑配置的重要部分是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</div><div class="line">&lt;metainfo&gt;</div><div class="line">  &lt;schemaVersion&gt;2.0&lt;/schemaVersion&gt;</div><div class="line">  &lt;services&gt;</div><div class="line">    &lt;service&gt;</div><div class="line">      &lt;name&gt;HDFS&lt;/name&gt;</div><div class="line">      &lt;displayName&gt;HDFS&lt;/displayName&gt;</div><div class="line">      &lt;comment&gt;Apache Hadoop Distributed File System&lt;/comment&gt;</div><div class="line">      &lt;version&gt;2.1.0.2.0&lt;/version&gt;</div><div class="line">      &lt;components&gt;</div><div class="line">        ...</div><div class="line">        &lt;component&gt;</div><div class="line">          &lt;name&gt;HDFS_CLIENT&lt;/name&gt;</div><div class="line">          ...</div><div class="line">          &lt;configFiles&gt;</div><div class="line">            &lt;configFile&gt;</div><div class="line">              &lt;type&gt;xml&lt;/type&gt;</div><div class="line">              &lt;fileName&gt;hdfs-site.xml&lt;/fileName&gt;</div><div class="line">              &lt;dictionaryName&gt;hdfs-site&lt;/dictionaryName&gt;</div><div class="line">            &lt;/configFile&gt;</div><div class="line">            &lt;configFile&gt;</div><div class="line">              &lt;type&gt;xml&lt;/type&gt;</div><div class="line">              &lt;fileName&gt;core-site.xml&lt;/fileName&gt;</div><div class="line">              &lt;dictionaryName&gt;core-site&lt;/dictionaryName&gt;</div><div class="line">            &lt;/configFile&gt;</div><div class="line">            &lt;configFile&gt;</div><div class="line">              &lt;type&gt;env&lt;/type&gt;</div><div class="line">              &lt;fileName&gt;log4j.properties&lt;/fileName&gt;</div><div class="line">              &lt;dictionaryName&gt;hdfs-log4j,yarn-log4j&lt;/dictionaryName&gt;</div><div class="line">            &lt;/configFile&gt;                         </div><div class="line">            &lt;configFile&gt;</div><div class="line">              &lt;type&gt;env&lt;/type&gt;</div><div class="line">              &lt;fileName&gt;hadoop-env.sh&lt;/fileName&gt;</div><div class="line">              &lt;dictionaryName&gt;hadoop-env&lt;/dictionaryName&gt;</div><div class="line">            &lt;/configFile&gt;</div><div class="line">          &lt;/configFiles&gt;</div><div class="line">          ...</div><div class="line">          &lt;configuration-dependencies&gt;</div><div class="line">             &lt;config-type&gt;core-site&lt;/config-type&gt;</div><div class="line">             &lt;config-type&gt;hdfs-site&lt;/config-type&gt;</div><div class="line">          &lt;/configuration-dependencies&gt;</div><div class="line">        &lt;/component&gt;</div><div class="line">          ...</div><div class="line">      &lt;/components&gt;</div><div class="line">  </div><div class="line">      &lt;configuration-dir&gt;configuration&lt;/configuration-dir&gt;</div><div class="line">      &lt;configuration-dependencies&gt;</div><div class="line">        &lt;config-type&gt;core-site&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;hdfs-site&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;hadoop-env&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;hadoop-policy&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;hdfs-log4j&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;ranger-hdfs-plugin-properties&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;ssl-client&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;ssl-server&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;ranger-hdfs-audit&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;ranger-hdfs-policymgr-ssl&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;ranger-hdfs-security&lt;/config-type&gt;</div><div class="line">        &lt;config-type&gt;ams-ssl-client&lt;/config-type&gt;</div><div class="line">      &lt;/configuration-dependencies&gt;</div><div class="line">    &lt;/service&gt;</div><div class="line">  &lt;/services&gt;</div><div class="line">&lt;/metainfo&gt;</div></pre></td></tr></table></figure></configuration-dir></p>
<blockquote>
<p>config-type - 字符串表示的一组配置。例如：core-site, hdfs-site, yarn-site等。当配置在Ambari中保存，它们被固化到一个config-type版本中，而且这个版本是不可变的。如果你更改并保存HDFS core-site配置4次，你将有4个版本的config-type core-site。同样，当一个service的配置被保存时，只有更改的config-type被更新。<br>configFiles - 列出由<component>处理的配置文件。<br>configFile - 某种类型的一个配置文件。<br>    type - 基于文件内容的不同指定文件的类型<br>        xml - Hadoop中友好的方式，XML文件。<br>        env - 通常用于将内容值作为模版的脚本。模版具有配置标签，并且它的值在运行时生成。<br>        properties - 生成属性文件，每条属性的格式为key=value。<br>    dictionaryName - 配置类型的名字。<br>configuration-dependencies - 列出component或service所依赖的config-type的列表。<br>configuration-dir - configFiles所指定的文件所处的目录。可选的，默认为configuration。</component></p>
</blockquote>
<h3 id="Adding-new-configs-in-a-config-type"><a href="#Adding-new-configs-in-a-config-type" class="headerlink" title="Adding new configs in a config-type"></a>Adding new configs in a config-type</h3><p>向config-type中添加一个配置项时有很多不同的参数可选。它们在<a href="https://cwiki.apache.org/confluence/display/AMBARI/Configuration+support+in+Ambari" title="config-type的可选属性" target="_blank" rel="external">这里</a>被全面介绍。</p>
<h3 id="UI-Categories"><a href="#UI-Categories" class="headerlink" title="UI - Categories"></a>UI - Categories</h3><p>上面的定义的配置在service的配置页面显示。<br>要自定义分类并在UI中对配置进行排序，需要更新下面的文件。<br>Create Category - 更新 ambari-web/app/models/stack_service.js 文件，用来添加自己的service，以及你的新分类。<br>Use Category - 要将配置置于某种分类中，并指定配置的顺序，将配置添加到  ambari-web/app/data/HDP2/site_properties.js 文件中。在这个文件中，可以指定需要使用到分类，以及配置的索引。ambari-web/app/data中的stack文件夹时分层的且继承自前一个版本。片段中的配置属性在这里定义。例如 <a href="https://github.com/apache/ambari/blob/trunk/ambari-web/app/data/HDP2.2/hive_properties.js" title="Hive Categories" target="_blank" rel="external">Hive Categories</a>, <a href="https://github.com/apache/ambari/blob/trunk/ambari-web/app/data/HDP2.2/tez_properties.js" title="Tez Categories" target="_blank" rel="external">Tez Categories</a></p>
<h3 id="UI-Enhanced-Configs"><a href="#UI-Enhanced-Configs" class="headerlink" title="UI - Enhanced Configs"></a>UI - Enhanced Configs</h3><p>Enhanced Config特性使得服务提供者能够定制他们自己的service配置，并确定哪些配置主要显示给用户，而不需要修改任何UI代码。自定义包括为service提供友好的布局，更好的控制（sliders, combos, lists, toggles, spinners, etc）、更好的验证（minimum, maximum, enums）、自动的单位转换（MB, GB, seconds, milliseconds, etc.）、配置依赖以及默认值的动态推荐。<br>servier提供者能够达成上面所有的，只需要在stacks文件夹中修改它们service的定义。<br>在<a href="https://cwiki.apache.org/confluence/display/AMBARI/Enhanced+Configs" title="Enhanced Configs" target="_blank" rel="external">Enhanced Configs</a>页面中查看更多。</p>
<h2 id="Alerts"><a href="#Alerts" class="headerlink" title="Alerts"></a>Alerts</h2><p>通过提供一个alert.js文件，每个service都能够定义Ambari应该跟踪的警报。<br>在<a href="https://cwiki.apache.org/confluence/display/AMBARI/Alerts" title="Alerts wiki page" target="_blank" rel="external">Alerts wiki page</a>页面能够读到更多关于报警框架的信息，而alerts.json文件的格式在<a href="https://github.com/apache/ambari/blob/branch-2.1/ambari-server/docs/api/v1/alert-definitions.md" title="Alerts definition document" target="_blank" rel="external">Alerts definition document</a>中可以了解到。</p>
<h2 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h2><p>Ambari能够对一个集群启用或禁用Kerberos。要通知Ambari服务及其组件使用的身份和配置，每个服务需要提供一个kerberos.json文件。<br>在<a href="https://cwiki.apache.org/confluence/display/AMBARI/Automated+Kerberizaton" title="Automated Kerberization" target="_blank" rel="external">Automated Kerberization</a>wiki页面可以读到关于Kerberos的支持的信息，还可以在<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/docs/security/kerberos/kerberos_descriptor.md" title="Kerberos Descriptor documentation" target="_blank" rel="external">Kerberos Descriptor documentation</a>中得到Kerberos的描述信息。</p>
<h2 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h2><p>对于Hadoop和Ambari管理的集群，Ambari提供了<a href="https://cwiki.apache.org/confluence/display/AMBARI/Metrics" title="Ambari Metrics System" target="_blank" rel="external">Ambari Metrics System</a>服务，用来收集、聚合系统的metrics。<br>每个service可以定义哪些metrics能够被AMS收集，通过metrics.json文件来定义。你可以在<a href="https://cwiki.apache.org/confluence/display/AMBARI/Stack+Defined+Metrics" title="Stack Defined Metrics" target="_blank" rel="external">Stack Defined Metrics</a>页面中得到关于metrics.json格式的信息。</p>
<h2 id="Quick-Links"><a href="#Quick-Links" class="headerlink" title="Quick Links"></a>Quick Links</h2><p>一个service通过向一个文本添加metainfo来实现向Ambari web UI中添加一个快速链接的列表，添加数据的文本遵循一个预定义JSON格式。Ambari server解析quicklink JSON文件，并将它的内容展示在UI。因此，Ambari web UI能够根据这些信息计算quick link URLs，并相应的填充quicklink的下拉列表。<br>关于quick link的JSON文件的设计，可以参看<a href="https://cwiki.apache.org/confluence/display/AMBARI/Quick+Links" title="Quick Links" target="_blank" rel="external">Quick Links</a>页面。</p>
<h2 id="Widgets"><a href="#Widgets" class="headerlink" title="Widgets"></a>Widgets</h2><p>每个service都可以通过定一个widgets.json文件来定义在service的摘要页面上默认显示哪些widgets和heatmaps。<br>你可以在<a href="https://cwiki.apache.org/confluence/display/AMBARI/Enhanced+Service+Dashboard" title="Enhanced Service Dashboard" target="_blank" rel="external">Enhanced Service Dashboard</a>页面中看到更多关于widgets描述符的信息。</p>
<h2 id="Role-Command-Order"><a href="#Role-Command-Order" class="headerlink" title="Role Command Order"></a>Role Command Order</h2><p>从Ambari 2.2开始，每个service通过在service文件夹中包含一个role_rommand_order.json文件来定义自己的role command order。这个service应当只指定它的组件到其他组件之间的关系。换句话说，如果service只包含COMP_X，那么servier应当只列出与COMP_X相关的依赖。如果COMP_X启动，它依赖于NameNode的启动，当NameNode停止时，NameNode应该要等COMP_X先停止，下面的信息将被包含在role command order中：<br>Example service role_command_order.json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&quot;COMP_X-START&quot;: [&quot;NAMENODE-START&quot;],</div><div class="line">&quot;NAMENODE-STOP&quot;: [&quot;COMP_X-STOP&quot;]</div></pre></td></tr></table></figure></p>
<p>service的role command order条目将会与stack中定义的role command order合并。例如，因为stack已经依赖NAMENODE_STOP，在上面的例子中，COMP_X-STOP将被添加到NAMENODE-STOP的依赖，此外，COMP_X-START对NAMENODE-START的依赖将作为一个新的依赖项被添加。<br>对于role command order的更多信息，可以查看<a href="https://cwiki.apache.org/confluence/display/AMBARI/How-To+Define+Stacks+and+Services#How-ToDefineStacksandServices-RoleCommandOrder" title="Role Command Order" target="_blank" rel="external">Role Command Order</a>章节。</p>
<h2 id="Service-Advisor"><a href="#Service-Advisor" class="headerlink" title="Service Advisor"></a>Service Advisor</h2><p>从Ambari 2.4开始，每个service可以选择定义自己的service advisor，而不是在stack advisor中定义它的配置和布局的细节。这专门用于哪些没有在stack中定义的自定义service。service能够在它的service文件夹中编写一个名为service-advisor.py的Python脚本来提供Service Advisor的能力。这个文件夹可以位于定义service的stack的services目录或者用来定义可继承service的common-services目录。例如：<a href="https://github.com/apache/ambari/tree/trunk/ambari-server/src/main/resources/common-services/HAWQ/2.0.0" title="common-services/HAWQ/2.0.0" target="_blank" rel="external">common-services/HAWQ/2.0.0</a>。<br>与Stack-advisor脚本不同，service-advisor脚本不会自动的继承父级service的service-advisor脚本。service-advisor脚本需要声明来继承它们父级service的service-advisor脚本。下面的代码向你展示了如何引用父级service的service-advisor.py。在这个例子中，它继承了位于resource/stacks中的顶级service-advisor.py。<br>Sample service-advisor.py file inheritance<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))</div><div class="line">STACKS_DIR = os.path.join(SCRIPT_DIR, <span class="string">'../../../stacks/'</span>)</div><div class="line">PARENT_FILE = os.path.join(STACKS_DIR, <span class="string">'service_advisor.py'</span>)</div><div class="line"> </div><div class="line"><span class="keyword">try</span>:</div><div class="line">  <span class="keyword">with</span> open(PARENT_FILE, <span class="string">'rb'</span>) <span class="keyword">as</span> fp:</div><div class="line">    service_advisor = imp.load_module(<span class="string">'service_advisor'</span>, fp, PARENT_FILE, (<span class="string">'.py'</span>, <span class="string">'rb'</span>, imp.PY_SOURCE))</div><div class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">  traceback.print_exc()</div><div class="line">  <span class="keyword">print</span> <span class="string">"Failed to load parent"</span></div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HAWQ200ServiceAdvisor</span><span class="params">(service_advisor.ServiceAdvisor)</span>:</span></div></pre></td></tr></table></figure></p>
<p>与stack advisors类似，service advisor在4个重要概念上提供了信息：</p>
<blockquote>
<p>1、推荐集群上service的布局。<br>2、推荐service配置。<br>3、验证集群上service的布局。<br>4、验证service配置。<br>通过提供的service-advisor.py文件，service能够动态控制上面的每一个。<br>对于service-advisor脚本来说主要接口是如何调用上面的每一项，以及给它们提供什么数据。</p>
</blockquote>
<p>Base service_advisor.py from resources/stacks<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceAdvisor</span><span class="params">(DefaultStackAdvisor)</span>:</span></div><div class="line">  <span class="string">"""</span></div><div class="line">  Abstract class implemented by all service advisors.</div><div class="line">  """</div><div class="line"> </div><div class="line">  <span class="string">"""</span></div><div class="line">  If any components of the service should be colocated with other services,</div><div class="line">  this is where you should set up that layout.  Example:</div><div class="line"> </div><div class="line">    # colocate HAWQSEGMENT with DATANODE, if no hosts have been allocated for HAWQSEGMENT</div><div class="line">    hawqSegment = [component for component in serviceComponents if component["StackServiceComponents"]["component_name"] == "HAWQSEGMENT"][0]</div><div class="line">    if not self.isComponentHostsPopulated(hawqSegment):</div><div class="line">      for hostName in hostsComponentsMap.keys():</div><div class="line">        hostComponents = hostsComponentsMap[hostName]</div><div class="line">        if &#123;"name": "DATANODE"&#125; in hostComponents and &#123;"name": "HAWQSEGMENT"&#125; not in hostComponents:</div><div class="line">          hostsComponentsMap[hostName].append( &#123; "name": "HAWQSEGMENT" &#125; )</div><div class="line">        if &#123;"name": "DATANODE"&#125; not in hostComponents and &#123;"name": "HAWQSEGMENT"&#125; in hostComponents:</div><div class="line">          hostComponents.remove(&#123;"name": "HAWQSEGMENT"&#125;)</div><div class="line">  """</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">colocateService</span><span class="params">(self, hostsComponentsMap, serviceComponents)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line">  <span class="string">"""</span></div><div class="line">  Any configuration recommendations for the service should be defined in this function.</div><div class="line">  This should be similar to any of the recommendXXXXConfigurations functions in the stack_advisor.py</div><div class="line">  such as recommendYARNConfigurations().</div><div class="line">  """</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getServiceConfigurationRecommendations</span><span class="params">(self, configurations, clusterSummary, services, hosts)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line">  <span class="string">"""</span></div><div class="line">  Returns an array of Validation objects about issues with the hostnames to which components are assigned.</div><div class="line">  This should detect validation issues which are different than those the stack_advisor.py detects.</div><div class="line">  The default validations are in stack_advisor.py getComponentLayoutValidations function.</div><div class="line">  """</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getServiceComponentLayoutValidations</span><span class="params">(self, services, hosts)</span>:</span></div><div class="line">    <span class="keyword">return</span> []</div><div class="line"> </div><div class="line">  <span class="string">"""</span></div><div class="line">  Any configuration validations for the service should be defined in this function.</div><div class="line">  This should be similar to any of the validateXXXXConfigurations functions in the stack_advisor.py</div><div class="line">  such as validateHDFSConfigurations.</div><div class="line">  """</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getServiceConfigurationsValidationItems</span><span class="params">(self, configurations, recommendedDefaults, services, hosts)</span>:</span></div><div class="line">    <span class="keyword">return</span> []</div></pre></td></tr></table></figure></p>
<h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3><ul><br>    <li><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/service_advisor.py#L51" title="Service Advisor interface" target="_blank" rel="external">Service Advisor interface</a></li><br>    <li><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HAWQ/2.0.0/service_advisor.py" title="HAWQ 2.0.0 Service Advisor implementation" target="_blank" rel="external">HAWQ 2.0.0 Service Advisor implementation</a></li><br>    <li><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/PXF/3.0.0/service_advisor.py" title="PXF 3.0.0 Service Advisor implementation" target="_blank" rel="external">PXF 3.0.0 Service Advisor implementation</a></li><br></ul>

<h2 id="Service-Upgrade"><a href="#Service-Upgrade" class="headerlink" title="Service Upgrade"></a>Service Upgrade</h2><p>从Ambari开始，每个service能够在它的service definition中定义它自己的更新。这对哪些不再需要修改stack的upgrade-packs的自定义service，以便它们融合到集群的更新。</p>
<p>每个service能够定义upgrade-packs，upgrade-packs是一些XML文件，它们描述了某个service的更新进程已经这个更新包如何与所有的stack更新包相关联。这些upgrade-pack XML文件在service的upgrades/文件夹中的独立的子文件夹中，这些子文件夹指明了需要扩展的stack版本。测试代码中的一些例子。</p>
<h3 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples"></a>Examples</h3><ul><br>    <li><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/test/resources/stacks/HDP/2.0.5/services/HDFS/upgrades/" title="Upgrades folder" target="_blank" rel="external">Upgrades folder</a></li><br>    <li><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/test/resources/stacks/HDP/2.0.5/services/HDFS/upgrades/HDP/2.2.0/upgrade_test_15388.xml" title="Upgrade-pack XML" target="_blank" rel="external">Upgrade-pack XML</a></li><br></ul>

<p>service定义的每个upgrade-pack通过一个特定的stack版本，应当匹配service定义的文件名。例如，在测试代码中，HDP 2.2.0有一个名为upgrade_test_15388.xml的upgrade-pack。HDFS service定义了一个extension来扩展那个upgrade pack<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/test/resources/stacks/HDP/2.0.5/services/HDFS/upgrades/HDP/2.2.0/upgrade_test_15388.xml" title="HDP/2.0.5/services/HDFS/upgrades/HDP/2.2.0/upgrade_test_15388.xml" target="_blank" rel="external">HDP/2.0.5/services/HDFS/upgrades/HDP/2.2.0/upgrade_test_15388.xml</a>。在这个例子中，upgrade-pack定义在HDP/2.0.5的stack中。这个upgrade-pack是HDP/2.2.0的一个扩展，因为他被定义在upgrade/HDP/2.2.0目录中。最终，扩展到upgrad-pack upgrade_test_15388.xml的service的名字与HDP/2.2.0/upgrades中的upgrade-pack的名字匹配。<br>对于service的文件格式与stack的有很大的相同。target、target-stack和type属性应该和stack的upgrade-pack的信息完全对应。service能够添加自己的前提检测。</p>
<p>General Attributes and Prerequisite Checks<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">upgrade</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">target</span>&gt;</span>2.4.*<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">target-stack</span>&gt;</span>HDP-2.4.0<span class="tag">&lt;/<span class="name">target-stack</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>ROLLING<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">prerequisite-checks</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">check</span>&gt;</span>org.apache.ambari.server.checks.FooCheck<span class="tag">&lt;/<span class="name">check</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">prerequisite-checks</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>upgrade-pack的<order>部分，由<group>标签组成，就像stack的upgrade-pack。关键的不同是如何定义这些<group>，使它们与stack的upgrade pack的<group>或其他service的upgrade pack的<group>相关联。在第一个例子中，我们引入了名为PRE_CLUSTER的<group>并为名为FOO的service新增了一个<execute-stage>。该项应该在基于<add-after-group-entry>标签的HDFS之后的<execute-stage>中添加。</execute-stage></add-after-group-entry></execute-stage></group></group></group></group></group></order></p>
<p>Order Section - Add After Group Entry<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">order</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">group</span> <span class="attr">xsi:type</span>=<span class="string">"cluster"</span> <span class="attr">name</span>=<span class="string">"PRE_CLUSTER"</span> <span class="attr">title</span>=<span class="string">"Pre &#123;&#123;direction.text.proper&#125;&#125;"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">add-after-group-entry</span>&gt;</span>HDFS<span class="tag">&lt;/<span class="name">add-after-group-entry</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">execute-stage</span> <span class="attr">service</span>=<span class="string">"FOO"</span> <span class="attr">component</span>=<span class="string">"BAR"</span> <span class="attr">title</span>=<span class="string">"Backup FOO"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">task</span> <span class="attr">xsi:type</span>=<span class="string">"manual"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">message</span>&gt;</span>Back FOO up.<span class="tag">&lt;/<span class="name">message</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">task</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">execute-stage</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">group</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>同样的语法也可以被用于service检查优先级和group services等。</p>
<p>Order Section - Further Add After Group Entry Examples<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"SERVICE_CHECK1"</span> <span class="attr">title</span>=<span class="string">"All Service Checks"</span> <span class="attr">xsi:type</span>=<span class="string">"service-check"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">add-after-group-entry</span>&gt;</span>ZOOKEEPER<span class="tag">&lt;/<span class="name">add-after-group-entry</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">priority</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service</span>&gt;</span>HBASE<span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">priority</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"CORE_MASTER"</span> <span class="attr">title</span>=<span class="string">"Core Masters"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">add-after-group-entry</span>&gt;</span>YARN<span class="tag">&lt;/<span class="name">add-after-group-entry</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"HBASE"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">component</span>&gt;</span>HBASE_MASTER<span class="tag">&lt;/<span class="name">component</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>还可以在stack的upgrade-pack中增加新的group，并将它们排列在其他group之后。在下面的例子中，我们在使用<add-after-group>标签的HIVE的group之后增加了一个名为FOO的group。</add-after-group></p>
<p>Order Section - Add After Group<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"FOO"</span> <span class="attr">title</span>=<span class="string">"Foo"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">add-after-group</span>&gt;</span>HIVE<span class="tag">&lt;/<span class="name">add-after-group</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">skippable</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skippable</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">allow-retry</span>&gt;</span>false<span class="tag">&lt;/<span class="name">allow-retry</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"FOO"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">component</span>&gt;</span>BAR<span class="tag">&lt;/<span class="name">component</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>你还可以在同一个<group>中同时创建<add-after-group>和<add-after-groujp-entry>。这将会在指定的group不存在的情况下才会创建一个新的group，并且会将他排列在<add-after-group>指定的group之后。<add-after-group-entry>将会确定它的group的service的内部排序、优先级和执行阶段。</add-after-group-entry></add-after-group></add-after-groujp-entry></add-after-group></group></p>
<p>Order Section - Add After Group<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"FOO"</span> <span class="attr">title</span>=<span class="string">"Foo"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">add-after-group</span>&gt;</span>HIVE<span class="tag">&lt;/<span class="name">add-after-group</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">add-after-group-entry</span>&gt;</span>FOO<span class="tag">&lt;/<span class="name">add-after-group-entry</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">skippable</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skippable</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">allow-retry</span>&gt;</span>false<span class="tag">&lt;/<span class="name">allow-retry</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"FOO2"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">component</span>&gt;</span>BAR2<span class="tag">&lt;/<span class="name">component</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>upgrade-pack剩余的<processing>部分，与stack的upgrade-pack的相同。</processing></p>
<p>Processing Section<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">processing</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"FOO"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">"BAR"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">upgrade</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">task</span> <span class="attr">xsi:type</span>=<span class="string">"restart-task"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">upgrade</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">component</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">"BAR2"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">upgrade</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">task</span> <span class="attr">xsi:type</span>=<span class="string">"restart-task"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">upgrade</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">component</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">processing</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h1 id="Define-Stack"><a href="#Define-Stack" class="headerlink" title="Define Stack"></a>Define Stack</h1><p>一个Stack就是一个版本化的service的集合。每个stack就是一个定义在ambari-server/src/main/resource/stacks中的一个文件夹。安装ambari之后，stack的定义则位于ambari-server主机的/var/lib/ambari-server/resources/stacks中。<br>每个stack文件夹中包含该stack的每个版本的子文件夹。一些stack版本可用，一些不可用。每个stack版本包含一些service，这些service有的继承自common-services，有些在stack版本的services中定义。<br><img src="http://oaavtz33a.bkt.clouddn.com/Screen%20Shot%202016-03-08%20at%2012.46.40%20PM.png"><br>Example : <a href="https://github.com/apache/ambari/tree/trunk/ambari-server/src/main/resources/stacks/HDP/2.4" title="HDP stack.HDP-2.4 stack version" target="_blank" rel="external">HDP stack.HDP-2.4 stack version</a>。</p>
<h2 id="Stack-Version-Descriptor"><a href="#Stack-Version-Descriptor" class="headerlink" title="Stack-Version Descriptor"></a>Stack-Version Descriptor</h2><p>每个Stack-version应当提供一个metainfo.xml（如：<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.3/metainfo.xml" title="HDP-2.3" target="_blank" rel="external">HDP-2.3</a>、<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.4/metainfo.xml" title="HDP-2.4" target="_blank" rel="external">HDP-2.4</a> ）文件作为描述符，它如下描述了stack-verion：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">metainfo</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">versions</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">active</span>&gt;</span>true<span class="tag">&lt;/<span class="name">active</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">versions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">extends</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">extends</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">minJdk</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">minJdk</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">maxJdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maxJdk</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">metainfo</span>&gt;</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>versions/active - 当前版本的stack是否还可以用于安装。如果不可用，这个版本在安装的时候将不会在UI中显示。<br>extends - 当前stack继承的版本。进行继承的stack版本会继承service以及父stack版本的所有方面。<br>minJdk - stack版本支持的最低JDK版本。在安装向导期间如果被Ambari使用的JDK低于这个版本，用户将被警告。<br>maxJdk - stack版本支持的最高JDK版本。在安装向导期间，如果被Ambari使用的JDK版本高于这个版本，用户将被警告。</p>
</blockquote>
<h2 id="Stack-Properties"><a href="#Stack-Properties" class="headerlink" title="Stack Properties"></a>Stack Properties</h2><p>stack必须包含或继承一个属性字典，属性字典包含两个文件：<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/properties/stack_features.json" title="stack_features.json" target="_blank" rel="external">stack_features.json</a>和<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/properties/stack_tools.json" title="stack_tools.json" target="_blank" rel="external">stack_tools.json</a>。这个字典是在Ambari 2.4中新增的。<br>stack_features.json中包含了一个features的列表，这个列表指定了哪些版本的stack包含这些特性。<br>特性列表由特定的Ambari版本所确定。特定Ambari版本的详细列表能够在HDP/2.0.6/properties/stack_features.json中找到。每个feature由name、description以及特性所支持stack的最高版本和最低版本来构成。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"stack_features"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"snappy"</span>,</div><div class="line">      <span class="attr">"description"</span>: <span class="string">"Snappy compressor/decompressor support"</span>,</div><div class="line">      <span class="attr">"min_version"</span>: <span class="string">"2.0.0.0"</span>,</div><div class="line">      <span class="attr">"max_version"</span>: <span class="string">"2.2.0.0"</span></div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>stack_tools.json包含了stack_selector和conf_selector这两个工具对应的名称以及安装位置。<br>任何自定义的stack必须包含这两个JSON文件。更多的信息请查看<a href="https://cwiki.apache.org/confluence/display/AMBARI/Stack+Properties" title="Stack Properties" target="_blank" rel="external">Stack Properties</a>的wiki页面。</p>
<h2 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h2><p>每个stack版本中都包含services，这些services要么是引用的common-services中的，要么是在stack版本中services文件夹下定义的。<br>common-services中定义的services能够被多个stack共享。如果他们不会被共享，那么他们可以定义在stack版本中。</p>
<h3 id="Reference-common-services"><a href="#Reference-common-services" class="headerlink" title="Reference common-services"></a>Reference common-services</h3><p>要引用common-services中的一个service，service描述文件需要使用<extends>项。（例如： <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/services/HDFS/metainfo.xml" title="DFS in HDP-2.0.6" target="_blank" rel="external">HDFS in HDP-2.0.6</a>）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">metainfo</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">schemaVersion</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">schemaVersion</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">services</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>HDFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">extends</span>&gt;</span>common-services/HDFS/2.1.0.2.0<span class="tag">&lt;/<span class="name">extends</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">services</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">metainfo</span>&gt;</span></div></pre></td></tr></table></figure></extends></p>
<h3 id="Define-Service-1"><a href="#Define-Service-1" class="headerlink" title="Define Service"></a>Define Service</h3><p>与common-services中定义的services格式相同，可以子啊services文件夹中定义新的service。<br>Examples：</p>
<ul><br>    <li><a href="https://github.com/apache/ambari/tree/trunk/ambari-server/src/main/resources/stacks/BIGTOP/0.8/services/HDFS" title="HDFS in BIGTOP-0.8" target="_blank" rel="external">HDFS in BIGTOP-0.8</a></li><br>    <li><a href="https://github.com/apache/ambari/tree/trunk/ambari-server/src/main/resources/stacks/HDP/2.3.GlusterFS/services/GLUSTERFS" title="GlusterFS in HDP-2.3.GlusterFS" target="_blank" rel="external">GlusterFs in HDP-2.3.CusterFs</a></li><br></ul>

<h3 id="Extend-Service"><a href="#Extend-Service" class="headerlink" title="Extend Service"></a>Extend Service</h3><p>当一个版本继承另外一个版本时，它继承父级service的所有细节。它也可以自由的重写或删除继承的service定义的任何部分。<br>Examples：</p>
<ul><br>    <li>HDP-2.3/HDFS - <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.3/services/HDFS/metainfo.xml" title="添加NFS_GATEWAY组件，更新service版本和OS特定包" target="_blank" rel="external">添加NFS_GATEWAY组件，更新service版本和OS特定包</a></li><br>    <li>HDP-2.2/Storm - <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.2/services/STORM/metainfo.xml" title="删除了STORM_REST_API组件，更新service版本和OS特定包" target="_blank" rel="external">删除了STORM_REST_API组件，更新service版本和OS特定包</a></li><br>    <li>HDP-2.3/YARN - <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.3/services/YARN/configuration/capacity-scheduler.xml" title="从capacity-scheduler.mxl中删除YARN node-lable配置" target="_blank" rel="external">从capacity-scheduler.mxl中删除YARN node-lable配置</a></li><br>    <li>HDP-2.3/Kafka - <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.3/services/KAFKA/alerts.json" title="增加Kafka Broker进程告警" target="_blank" rel="external">增加Kafka Broker进程告警</a></li><br></ul>

<h2 id="Role-Command-Order-1"><a href="#Role-Command-Order-1" class="headerlink" title="Role Command Order"></a>Role Command Order</h2><p>Role是Component（如：NAMENODE、DATANODE、RESOURCEMANAGER、HBASE_MASTER等）的另一个名称。<br>顾名思义，它可以告诉Amberi在你stack中定义的component执行命令的顺序。<br>例如：”ZooKeeper Server 应当在启动NameNode之前启动”。“HBase Master应当在NameNode和DataNode启动之后再启动”。<br>这可以通过在stack-version文件夹中包含<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/role_command_order.json" title="role_command_order.json" target="_blank" rel="external">role_command_order.json</a>来具体说明。</p>
<h3 id="Format"><a href="#Format" class="headerlink" title="Format"></a>Format</h3><p>以JSON格式指定，这个文件包含一个JSON对象，并且顶级key是section名称或comments。如：<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/role_command_order.json" title="HDP-2.0.6" target="_blank" rel="external">HDP-2.0.6</a>。<br>在每个section对象内部，key描述了它对应的component的行为，value列出当前component-action之前应当完成的component-action。<br>Structure of role_command_order.json<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "_comment": "Section 1 comment",</div><div class="line">  "section_name_1": &#123;</div><div class="line">    "_comment": "Section containing role command orders",</div><div class="line">    "&lt;DEPENDENT_COMPONENT_1&gt;-&lt;COMMAND&gt;": ["&lt;DEPENDS_ON_COMPONENT_1&gt;-&lt;COMMAND&gt;", "&lt;DEPENDS_ON_COMPONENT_1&gt;-&lt;COMMAND&gt;"],</div><div class="line">    "&lt;DEPENDENT_COMPONENT_2&gt;-&lt;COMMAND&gt;": ["&lt;DEPENDS_ON_COMPONENT_3&gt;-&lt;COMMAND&gt;"],</div><div class="line">    ...</div><div class="line">  &#125;,</div><div class="line">  "_comment": "Next section comment",</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Sections"><a href="#Sections" class="headerlink" title="Sections"></a>Sections</h3><p>Ambari只使用了如下的sections：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Section Name</th>
<th style="text-align:left">When Used</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">general_deps</td>
<td style="text-align:left">适用于所有情况</td>
</tr>
<tr>
<td style="text-align:left">optional_glusterfs</td>
<td style="text-align:left">当集群有GLUSTERFS服务实例时</td>
</tr>
<tr>
<td style="text-align:left">optional_no_glusterfs</td>
<td style="text-align:left">当集群没有GLUSTERFS服务实例时</td>
</tr>
<tr>
<td style="text-align:left">namenode_optional_ha</td>
<td style="text-align:left">当安装了HDFS服务，且有JOURNALNODE组件时</td>
</tr>
<tr>
<td style="text-align:left">resourcemanager_optional_ha</td>
<td style="text-align:left">当安装了YARN服务，且存在多个RESOURCEMANAGER host-components存在时</td>
</tr>
</tbody>
</table>
<h3 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h3><p>Ambari当前支持的命令有：</p>
<blockquote>
<p>INSTALL<br>UNINSTALL<br>START<br>RESTART<br>STOP<br>EXECUTE<br>ABORT<br>UPGRADE<br>SERVICE_CHECK<br>CUSTOM_COMMAND<br>ACTIONEXECUTE</p>
</blockquote>
<h3 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples"></a>Examples</h3><table>
<thead>
<tr>
<th style="text-align:left">Role Command Order</th>
<th style="text-align:left">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">“HIVE_METASTORE-START”:[“MYSQL_SERVER-START”, “NAMENODE-START”]</td>
<td style="text-align:left">启动Hive Metastore之前先启动MySQL和NameNode。</td>
</tr>
<tr>
<td style="text-align:left">“MAPREDUCE_SERVICE_CHECK-SERVICE_CHECK”:[“NODEMANAGER-START”, “RESOURCEMANAGER-START”]</td>
<td style="text-align:left">MapReduce服务检查需要ResourceManager和NodeManager的启动。</td>
</tr>
<tr>
<td style="text-align:left">“ZOOKEEPER_SERVER-STOP”:[“HBASE_MASTER-STOP”, “HBASE_REGIONSERVER-STOP”, “METRICS_COLLECTOR-STOP”]</td>
<td style="text-align:left">在停止Zookeeper之前，应该先确保HBase Master、Hbase RegionServers和AMS Metrics收集器先停止。</td>
</tr>
</tbody>
</table>
<h2 id="Repositories"><a href="#Repositories" class="headerlink" title="Repositories"></a>Repositories</h2><p>通过提供一个repos/repoinfo.xml（如 <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/repos/repoinfo.xml" title="HDP-2.0.6" target="_blank" rel="external">HDP-2.0.6</a>），每个stack版本可以提供package的库的位置来使用。<br>repoinfo.xml文件中包含的库根据操作系统进行分组。每个os指定一个库列表，这些库列表会在stack版本安装时展示给用户。<br>这些库与<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/common-services/HDFS/2.1.0.2.0/metainfo.xml#L161" title="packages defined in a service&#39;s metainfo.xml" target="_blank" rel="external">packages defined in a service’s metainfo.xml</a>配合使用，以便在系统上安装正确的。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">reposinfo</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">os</span> <span class="attr">family</span>=<span class="string">"redhat6"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repo</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">baseurl</span>&gt;</span>http://public-repo-1.hortonworks.com/HDP/centos6/2.x/updates/2.0.6.1<span class="tag">&lt;/<span class="name">baseurl</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">repoid</span>&gt;</span>HDP-2.0.6<span class="tag">&lt;/<span class="name">repoid</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">reponame</span>&gt;</span>HDP<span class="tag">&lt;/<span class="name">reponame</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repo</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repo</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">baseurl</span>&gt;</span>http://public-repo-1.hortonworks.com/HDP-UTILS-1.1.0.17/repos/centos6<span class="tag">&lt;/<span class="name">baseurl</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">repoid</span>&gt;</span>HDP-UTILS-1.1.0.17<span class="tag">&lt;/<span class="name">repoid</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">reponame</span>&gt;</span>HDP-UTILS<span class="tag">&lt;/<span class="name">reponame</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repo</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">reposinfo</span>&gt;</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>baseurl - RPM库的URL，可以在这里找到repoid提供的软件。<br>repoid - baseurl地址使用的repo id。<br>reponame - 需要使用的repo的展示名。</p>
</blockquote>
<h3 id="Latest-Builds"><a href="#Latest-Builds" class="headerlink" title="Latest Builds"></a>Latest Builds</h3><p>尽管repository基本URL能够对某个特定repo提供更新，但是必须在构建时定义它。当repository变更位置或更新包位于不同网站时，这就会成为一个问题。<br>对于这样的情况，stack-version能够提供一个JSON文件，来提供要使用的其他repo URL。<br>例如： <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.3/repos/repoinfo.xml" title="HDP-2.3 repoinfo.xml uses &lt;latest&gt; file" target="_blank" rel="external">HDP-2.3 repoinfo.xml uses <latest> file</latest></a>，它指出最新的构建包的repository URL。</p>
<figure class="highlight plain"><figcaption><span>json</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    &quot;HDP-2.3&quot;:&#123;</div><div class="line">        &quot;latest&quot;:&#123;</div><div class="line">            &quot;centos6&quot;:&quot;http://s3.amazonaws.com/dev.hortonworks.com/HDP/centos6/2.x/BUILDS/2.3.6.0-3586/&quot;,</div><div class="line">            &quot;centos7&quot;:&quot;http://s3.amazonaws.com/dev.hortonworks.com/HDP/centos7/2.x/BUILDS/2.3.6.0-3586/&quot;,</div><div class="line">            &quot;debian6&quot;:&quot;http://s3.amazonaws.com/dev.hortonworks.com/HDP/debian6/2.x/BUILDS/2.3.6.0-3586/&quot;,</div><div class="line">            &quot;debian7&quot;:&quot;http://s3.amazonaws.com/dev.hortonworks.com/HDP/debian7/2.x/BUILDS/2.3.6.0-3586/&quot;,</div><div class="line">            &quot;suse11&quot;:&quot;http://s3.amazonaws.com/dev.hortonworks.com/HDP/suse11sp3/2.x/BUILDS/2.3.6.0-3586/&quot;,</div><div class="line">            &quot;ubuntu12&quot;:&quot;http://s3.amazonaws.com/dev.hortonworks.com/HDP/ubuntu12/2.x/BUILDS/2.3.6.0-3586/&quot;,</div><div class="line">            &quot;ubuntu14&quot;:&quot;http://s3.amazonaws.com/dev.hortonworks.com/HDP/ubuntu14/2.x/BUILDS/2.3.6.0-3586/&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Hooks"><a href="#Hooks" class="headerlink" title="Hooks"></a>Hooks</h2><p>stack-version会有非常基本且通用的指令，这些指令需要在某个Ambari命令之前或之后运行。<br>避免将代码在service脚本之间复制并要求用户确认，通过将前置代码和后置代码放到hooks文件夹中，Ambari提供了Hooks的功能。（如：<a href="https://github.com/apache/ambari/tree/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/hooks" title="HDP-2.0.6" target="_blank" rel="external">HDP-2.0.6</a>）<br><img src=""></p>
<h3 id="Command-Sub-Folders"><a href="#Command-Sub-Folders" class="headerlink" title="Command Sub-Folders"></a>Command Sub-Folders</h3><p>hooks子文件夹的命名模式为”<before|after>-<any|<commandname>&gt;”。<br>那意味着子文件夹中的scripts/hook.py文件是在命令之前运行还是之后运行。<br>Examples：</any|<commandname></before|after></p>
<table>
<thead>
<tr>
<th style="text-align:left">Sub-Folder</th>
<th style="text-align:left">Purpose</th>
<th style="text-align:left">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">before-START</td>
<td style="text-align:left">hook脚本，会在stack-version的任何组件启动之前被调用</td>
<td style="text-align:left"><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/hooks/before-START/scripts/hook.py#L30" title="HDP-2.0.6" target="_blank" rel="external">HDP-2.0.6</a> 1、设置hadoop的日志和pid目录。2、创建javahome的symlink。3、创建/etc/hadoop/conf/topology_script.py脚本</td>
</tr>
<tr>
<td style="text-align:left">before-INSTALL</td>
<td style="text-align:left">hook脚本，会在stack-version的任何组件安装之前被调用</td>
<td style="text-align:left"><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/hooks/before-START/scripts/hook.py#L30" title="HDP-2.0.6" target="_blank" rel="external">HDP-2.0.6</a> 1、在/etc/yum.repos.d中创建repo文件。 2、安装基本包，如curl、unzip等</td>
</tr>
</tbody>
</table>
<p>Ambari当前支持的命令，根据需要可以创建如下的子文件夹</p>
<table>
<thead>
<tr>
<th style="text-align:left">Prefix</th>
<th style="text-align:left">Command</th>
<th style="text-align:left">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">before</td>
<td style="text-align:left">INSTALL</td>
<td style="text-align:left">&nbsp;</td>
</tr>
<tr>
<td style="text-align:left">before</td>
<td style="text-align:left">UNINSTALL</td>
<td style="text-align:left">&nbsp;</td>
</tr>
<tr>
<td style="text-align:left">before</td>
<td style="text-align:left">START</td>
<td style="text-align:left">&nbsp;</td>
</tr>
<tr>
<td style="text-align:left">before</td>
<td style="text-align:left">RESTART</td>
<td style="text-align:left">&nbsp;</td>
</tr>
<tr>
<td style="text-align:left">before</td>
<td style="text-align:left">STOP</td>
<td style="text-align:left">&nbsp;</td>
</tr>
<tr>
<td style="text-align:left">after</td>
<td style="text-align:left">EXECUTE</td>
<td style="text-align:left">&nbsp;</td>
</tr>
<tr>
<td style="text-align:left">after</td>
<td style="text-align:left">ABORT</td>
<td style="text-align:left">&nbsp;</td>
</tr>
<tr>
<td style="text-align:left">after</td>
<td style="text-align:left">UPGRADE</td>
<td style="text-align:left">&nbsp;</td>
</tr>
<tr>
<td style="text-align:left">after</td>
<td style="text-align:left">SERVICE_CHECK</td>
<td style="text-align:left">&nbps;</td>
</tr>
<tr>
<td style="text-align:left">after</td>
<td style="text-align:left">&lt; custom_command&gt;</td>
<td style="text-align:left">用户指定的自定义命令，如HDFS指定的DECOMMISSION或REBALANCEHDFS这两个命令。</td>
</tr>
</tbody>
</table>
<p>script/hooks.py脚本应该导入<a href="https://github.com/apache/ambari/blob/trunk/ambari-common/src/main/python/resource_management/libraries/script/hook.py" title="resource_management.libraries.script.hook" target="_blank" rel="external">resource_management.libraries.script.hook</a>模块，并继承Hook类。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> resource_management.libraries.script.hook <span class="keyword">import</span> Hook</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomHook</span><span class="params">(Hook)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">hook</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="comment"># Do custom work</span></div><div class="line">     </div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  CustomHook().execute()</div></pre></td></tr></table></figure></p>
<h2 id="Configurations"><a href="#Configurations" class="headerlink" title="Configurations"></a>Configurations</h2><p>尽管大多数配置是在service级别设置的，但是也可以有适用于所有servies的配置，以便指示安装了此stack的集群的状态。<br>例如，像<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/configuration/cluster-env.xml#L25" target="_blank" rel="external">is security enabled?</a>，<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/configuration/cluster-env.xml#L46" target="_blank" rel="external">what user runs smoke tests?</a> 等。<br>这样的配置可以定义在sstack的<a href="https://github.com/apache/ambari/tree/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/configuration" target="_blank" rel="external">configuration文件夹</a>中。它们就像service级配置一样访问。</p>
<h3 id="Stack-Advisor"><a href="#Stack-Advisor" class="headerlink" title="Stack Advisor"></a>Stack Advisor</h3><p>由于每个stack包含多个复杂的service，因此有必要动态确定services的布局以及确定某些配置的值。<br>stacks在services/目录中编写一个名为stack-advisor.py的Python脚本，使Ambari提供了Stack Advisor的能力。例如：<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/services/stack_advisor.py" title="HDP-2.0.6" target="_blank" rel="external">HDP-2.0.6</a>。Stack advisor脚本能够自动继承父级stack版本的stack advisor脚本。这允许较新的stack版本能够改变行为而不会影响之前的版本的行为。<br>Stack advisor在4个重要概念上提供了信息：</p>
<blockquote>
<p>Recommend layout of services on cluster。<br>Recommend service configurations。<br>Validate layout of services on cluster。<br>Validate service configurations。</p>
</blockquote>
<p>通过提供stack-advisor.py文件，能够动态的控制上面的每一项。<br>stack-advisor脚本的主要接口描述了上面每项应当如何调用，以及提供什么数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StackAdvisor</span><span class="params">(object)</span>:</span></div><div class="line">  <span class="string">"""</span></div><div class="line">  Abstract class implemented by all stack advisors. Stack advisors advise on stack specific questions.</div><div class="line"> </div><div class="line"> </div><div class="line">  Currently stack advisors provide following abilities:</div><div class="line">  - Recommend where services should be installed in cluster</div><div class="line">  - Recommend configurations based on host hardware</div><div class="line">  - Validate user selection of where services are installed on cluster</div><div class="line">  - Validate user configuration values</div><div class="line"> </div><div class="line">  Each of the above methods is passed in parameters about services and hosts involved as described below.</div><div class="line"> </div><div class="line"> </div><div class="line">    @type services: dictionary</div><div class="line">    @param services: Dictionary containing all information about services selected by the user.</div><div class="line">      Example: &#123;</div><div class="line">      "services": [</div><div class="line">        &#123;</div><div class="line">          "StackServices": &#123;</div><div class="line">            "service_name" : "HDFS",</div><div class="line">            "service_version" : "2.6.0.2.2",</div><div class="line">          &#125;,</div><div class="line">          "components" : [</div><div class="line">            &#123;</div><div class="line">              "StackServiceComponents" : &#123;</div><div class="line">                "cardinality" : "1+",</div><div class="line">                "component_category" : "SLAVE",</div><div class="line">                "component_name" : "DATANODE",</div><div class="line">                "display_name" : "DataNode",</div><div class="line">                "service_name" : "HDFS",</div><div class="line">                "hostnames" : []</div><div class="line">              &#125;,</div><div class="line">              "dependencies" : []</div><div class="line">            &#125;, &#123;</div><div class="line">              "StackServiceComponents" : &#123;</div><div class="line">                "cardinality" : "1-2",</div><div class="line">                "component_category" : "MASTER",</div><div class="line">                "component_name" : "NAMENODE",</div><div class="line">                "display_name" : "NameNode",</div><div class="line">                "service_name" : "HDFS",</div><div class="line">                "hostnames" : []</div><div class="line">              &#125;,</div><div class="line">              "dependencies" : []</div><div class="line">            &#125;,</div><div class="line">            ...</div><div class="line">          ]</div><div class="line">        &#125;,</div><div class="line">        ...</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  @type hosts: dictionary</div><div class="line">  @param hosts: Dictionary containing all information about hosts in this cluster</div><div class="line">    Example: &#123;</div><div class="line">      "items": [</div><div class="line">        &#123;</div><div class="line">          Hosts: &#123;</div><div class="line">            "host_name": "c6401.ambari.apache.org",</div><div class="line">            "public_host_name" : "c6401.ambari.apache.org",</div><div class="line">            "ip": "192.168.1.101",</div><div class="line">            "cpu_count" : 1,</div><div class="line">            "disk_info" : [</div><div class="line">              &#123;</div><div class="line">              "available" : "4564632",</div><div class="line">              "used" : "5230344",</div><div class="line">              "percent" : "54%",</div><div class="line">              "size" : "10319160",</div><div class="line">              "type" : "ext4",</div><div class="line">              "mountpoint" : "/"</div><div class="line">              &#125;,</div><div class="line">              &#123;</div><div class="line">              "available" : "1832436",</div><div class="line">              "used" : "0",</div><div class="line">              "percent" : "0%",</div><div class="line">              "size" : "1832436",</div><div class="line">              "type" : "tmpfs",</div><div class="line">              "mountpoint" : "/dev/shm"</div><div class="line">              &#125;</div><div class="line">            ],</div><div class="line">            "host_state" : "HEALTHY",</div><div class="line">            "os_arch" : "x86_64",</div><div class="line">            "os_type" : "centos6",</div><div class="line">            "total_mem" : 3664872</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        ...</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line"> </div><div class="line"> </div><div class="line">    Each of the methods can either return recommendations or validations.</div><div class="line"> </div><div class="line">    Recommendations are made in a Ambari Blueprints friendly format.</div><div class="line">    Validations are an array of validation objects.</div><div class="line">  """</div><div class="line"> </div><div class="line"> </div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">recommendComponentLayout</span><span class="params">(self, services, hosts)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Returns recommendation of which hosts various service components should be installed on.</div><div class="line"> </div><div class="line">    This function takes as input all details about services being installed, and hosts</div><div class="line">    they are being installed into, to generate hostname assignments to various components</div><div class="line">    of each service.</div><div class="line"> </div><div class="line"> </div><div class="line">    @type services: dictionary</div><div class="line">    @param services: Dictionary containing all information about services selected by the user.</div><div class="line">    @type hosts: dictionary</div><div class="line">    @param hosts: Dictionary containing all information about hosts in this cluster</div><div class="line">    @rtype: dictionary</div><div class="line">    @return: Layout recommendation of service components on cluster hosts in Ambari Blueprints friendly format.</div><div class="line">        Example: &#123;</div><div class="line">          "resources" : [</div><div class="line">            &#123;</div><div class="line">              "hosts" : [</div><div class="line">                "c6402.ambari.apache.org",</div><div class="line">                "c6401.ambari.apache.org"</div><div class="line">              ],</div><div class="line">              "services" : [</div><div class="line">                "HDFS"</div><div class="line">              ],</div><div class="line">              "recommendations" : &#123;</div><div class="line">                "blueprint" : &#123;</div><div class="line">                  "host_groups" : [</div><div class="line">                    &#123;</div><div class="line">                      "name" : "host-group-2",</div><div class="line">                      "components" : [</div><div class="line">                        &#123; "name" : "JOURNALNODE" &#125;,</div><div class="line">                        &#123; "name" : "ZKFC" &#125;,</div><div class="line">                        &#123; "name" : "DATANODE" &#125;,</div><div class="line">                        &#123; "name" : "SECONDARY_NAMENODE" &#125;</div><div class="line">                      ]</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                      "name" : "host-group-1",</div><div class="line">                      "components" :</div><div class="line">                        &#123; "name" : "HDFS_CLIENT" &#125;,</div><div class="line">                        &#123; "name" : "NAMENODE" &#125;,</div><div class="line">                        &#123; "name" : "JOURNALNODE" &#125;,</div><div class="line">                        &#123; "name" : "ZKFC" &#125;,</div><div class="line">                        &#123; "name" : "DATANODE" &#125;</div><div class="line">                      ]</div><div class="line">                    &#125;</div><div class="line">                  ]</div><div class="line">                &#125;,</div><div class="line">                "blueprint_cluster_binding" : &#123;</div><div class="line">                  "host_groups" : [</div><div class="line">                    &#123;</div><div class="line">                      "name" : "host-group-1",</div><div class="line">                      "hosts" : [ &#123; "fqdn" : "c6401.ambari.apache.org" &#125; ]</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                      "name" : "host-group-2",</div><div class="line">                      "hosts" : [ &#123; "fqdn" : "c6402.ambari.apache.org" &#125; ]</div><div class="line">                    &#125;</div><div class="line">                  ]</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">    """</div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">validateComponentLayout</span><span class="params">(self, services, hosts)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Returns array of Validation issues with service component layout on hosts</div><div class="line"> </div><div class="line"> </div><div class="line">    This function takes as input all details about services being installed along with</div><div class="line">    hosts the components are being installed on (hostnames property is populated for</div><div class="line">    each component). </div><div class="line"> </div><div class="line">    @type services: dictionary</div><div class="line">    @param services: Dictionary containing information about services and host layout selected by the user.</div><div class="line">    @type hosts: dictionary</div><div class="line">    @param hosts: Dictionary containing all information about hosts in this cluster</div><div class="line">    @rtype: dictionary</div><div class="line">    @return: Dictionary containing array of validation items</div><div class="line">        Example: &#123;</div><div class="line">          "items": [</div><div class="line">            &#123;</div><div class="line">              "type" : "host-group",</div><div class="line">              "level" : "ERROR",</div><div class="line">              "message" : "NameNode and Secondary NameNode should not be hosted on the same machine",</div><div class="line">              "component-name" : "NAMENODE",</div><div class="line">              "host" : "c6401.ambari.apache.org"</div><div class="line">            &#125;,</div><div class="line">            ...</div><div class="line">          ]</div><div class="line">        &#125; </div><div class="line">    """</div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"> </div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">recommendConfigurations</span><span class="params">(self, services, hosts)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Returns recommendation of service configurations based on host-specific layout of components.</div><div class="line"> </div><div class="line">    This function takes as input all details about services being installed, and hosts</div><div class="line">    they are being installed into, to recommend host-specific configurations.</div><div class="line"> </div><div class="line"> </div><div class="line">    @type services: dictionary</div><div class="line">    @param services: Dictionary containing all information about services and component layout selected by the user.</div><div class="line">    @type hosts: dictionary</div><div class="line">    @param hosts: Dictionary containing all information about hosts in this cluster</div><div class="line">    @rtype: dictionary</div><div class="line">    @return: Layout recommendation of service components on cluster hosts in Ambari Blueprints friendly format.</div><div class="line">        Example: &#123;</div><div class="line">         "services": [</div><div class="line">          "HIVE",</div><div class="line">          "TEZ",</div><div class="line">          "YARN"</div><div class="line">         ],</div><div class="line">         "recommendations": &#123;</div><div class="line">          "blueprint": &#123;</div><div class="line">           "host_groups": [],</div><div class="line">           "configurations": &#123;</div><div class="line">            "yarn-site": &#123;</div><div class="line">             "properties": &#123;</div><div class="line">              "yarn.scheduler.minimum-allocation-mb": "682",</div><div class="line">              "yarn.scheduler.maximum-allocation-mb": "2048",</div><div class="line">              "yarn.nodemanager.resource.memory-mb": "2048"</div><div class="line">             &#125;</div><div class="line">            &#125;,</div><div class="line">            "tez-site": &#123;</div><div class="line">             "properties": &#123;</div><div class="line">              "tez.am.java.opts": "-server -Xmx546m -Djava.net.preferIPv4Stack=true -XX:+UseNUMA -XX:+UseParallelGC",</div><div class="line">              "tez.am.resource.memory.mb": "682"</div><div class="line">             &#125;</div><div class="line">            &#125;,</div><div class="line">            "hive-site": &#123;</div><div class="line">             "properties": &#123;</div><div class="line">              "hive.tez.container.size": "682",</div><div class="line">              "hive.tez.java.opts": "-server -Xmx546m -Djava.net.preferIPv4Stack=true -XX:NewRatio=8 -XX:+UseNUMA -XX:+UseParallelGC",</div><div class="line">              "hive.auto.convert.join.noconditionaltask.size": "238026752"</div><div class="line">             &#125;</div><div class="line">            &#125;</div><div class="line">           &#125;</div><div class="line">          &#125;,</div><div class="line">          "blueprint_cluster_binding": &#123;</div><div class="line">           "host_groups": []</div><div class="line">          &#125;</div><div class="line">         &#125;,</div><div class="line">         "hosts": [</div><div class="line">          "c6401.ambari.apache.org",</div><div class="line">          "c6402.ambari.apache.org",</div><div class="line">          "c6403.ambari.apache.org"</div><div class="line">         ]</div><div class="line">        &#125;</div><div class="line">    """</div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">validateConfigurations</span><span class="params">(self, services, hosts)</span>:</span></div><div class="line">    <span class="string">""""</span></div><div class="line">    Returns array of Validation issues with configurations provided by user</div><div class="line">    This function takes as input all details about services being installed along with</div><div class="line">    configuration values entered by the user. These configurations can be validated against</div><div class="line">    service requirements, or host hardware to generate validation issues.</div><div class="line"> </div><div class="line"> </div><div class="line">    @type services: dictionary</div><div class="line">    @param services: Dictionary containing information about services and user configurations.</div><div class="line">    @type hosts: dictionary</div><div class="line">    @param hosts: Dictionary containing all information about hosts in this cluster</div><div class="line">    @rtype: dictionary</div><div class="line">    @return: Dictionary containing array of validation items</div><div class="line">        Example: &#123;</div><div class="line">         "items": [</div><div class="line">          &#123;</div><div class="line">           "config-type": "yarn-site",</div><div class="line">           "message": "Value is less than the recommended default of 682",</div><div class="line">           "type": "configuration",</div><div class="line">           "config-name": "yarn.scheduler.minimum-allocation-mb",</div><div class="line">           "level": "WARN"</div><div class="line">          &#125;</div><div class="line">         ]</div><div class="line">       &#125;</div><div class="line">    """</div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure></p>
<h4 id="Examples-3"><a href="#Examples-3" class="headerlink" title="Examples:"></a>Examples:</h4><blockquote>
<p><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/stack_advisor.py#L23" title="Stack Advisor interface" target="_blank" rel="external">Stack Advisor interface</a><br><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/stack_advisor.py#L303" title="Default Stack Advisor implementation - for all stacks" target="_blank" rel="external">Default Stack Advisor implementation - for all stacks</a><br><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/services/stack_advisor.py#L28" title="HDP(2.0.6) Default Stack Advisor implementation" target="_blank" rel="external">HDP(2.0.6) Default Stack Advisor implementation</a><br><a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/services/stack_advisor.py#L807" title="YARN container size calculate" target="_blank" rel="external">YARN container size calculate</a><br>Recommended configurations - <a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/stacks/HDP/2.0.6/services/stack_advisor.py#L222" target="_blank" rel="external">HDFS</a>，<a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/stacks/HDP/2.0.6/services/stack_advisor.py#L133" target="_blank" rel="external">YARN</a>，<a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/stacks/HDP/2.0.6/services/stack_advisor.py#L148" target="_blank" rel="external">MapReduce2</a>, <a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/stacks/HDP/2.0.6/services/stack_advisor.py#L245" target="_blank" rel="external">HBase</a> (HDP-2.0.6)，<a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/stacks/HDP/2.0.6/services/stack_advisor.py#L148" target="_blank" rel="external">HBase</a> (HDP-2.3)<br><a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/stacks/HDP/2.3/services/stack_advisor.py#L272" target="_blank" rel="external">Delete HBase Bucket Cache configs on smaller machines</a><br><a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/stacks/HDP/2.3/services/stack_advisor.py#L184" target="_blank" rel="external">Specify maximum value for Tez config</a></p>
</blockquote>
<h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h3><p>与stack的配置类似，大多属性都是在service级定义，然而也可以在stack-version级别定义全局属性来影响所有的services。<br>一些例子：<a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/properties/stack_tools.json#L2" target="_blank" rel="external">stack-selector and conf-selector</a> 或 <a href="https://github.com/apache/ambari/blob/trunk/ambari-server/src/main/resources/stacks/HDP/2.0.6/properties/stack_features.json#L5" target="_blank" rel="external">stack versions certain stack features</a>。这里的大多属性都是在Ambari 2.4版本引入的以影响stack信息参数化和促进common-service代码重用。<br>这些属性可以定义在stack的properties文件中的.json文件中。<br>stack属性的更多信息可以在<a href="https://cwiki.apache.org/confluence/x/pgPiAw" target="_blank" rel="external">Stack Properties section</a>找到。</p>
<h3 id="Widgets-1"><a href="#Widgets-1" class="headerlink" title="Widgets"></a>Widgets</h3><p>暂无</p>
<h3 id="Kerberos-1"><a href="#Kerberos-1" class="headerlink" title="Kerberos"></a>Kerberos</h3><p>之前我们已经在service级别介绍了Kerberos。<br>stack-version级别定义的Kerberos为所有的service提供了身份描述。</p>
<p>Examples：<a href="https://github.com/apache/ambari/blob/branch-2.2.1/ambari-server/src/main/resources/stacks/HDP/2.0.6/kerberos.json" target="_blank" rel="external">Smoke test user and SPNEGO user define in HDP-2.0.6</a></p>
<h3 id="Stack-Upgrades"><a href="#Stack-Upgrades" class="headerlink" title="Stack Upgrades"></a>Stack Upgrades</h3><p>暂无</p>
<h1 id="Writing-metainfo-xml"><a href="#Writing-metainfo-xml" class="headerlink" title="Writing metainfo.xml"></a>Writing metainfo.xml</h1><p>metainfo.xml是Ambari管理的service的定义，它描述了service的内容。它是service定义中最重要的文件。这一章来介绍metainfo.xml中的各个片段。</p>
<h2 id="Structure-1"><a href="#Structure-1" class="headerlink" title="Structure"></a>Structure</h2><p>不重要的字段使用斜体显示。<br>描述一个service的顶级字段如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Field</th>
<th style="text-align:left">What is it used for</th>
<th style="text-align:left">Sample Values</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>name</strong></td>
<td style="text-align:left">service的名字。这个名字必须是service所在Stack范围内唯一的。</td>
<td style="text-align:left">HDFS</td>
</tr>
<tr>
<td style="text-align:left"><strong>displayName</strong></td>
<td style="text-align:left">service在UI中显示的名字。</td>
<td style="text-align:left">HDFS</td>
</tr>
<tr>
<td style="text-align:left"><strong>version</strong></td>
<td style="text-align:left">service的版本。名字和版本一起确定了唯一的service。</td>
<td style="text-align:left">2.1.0.2.0</td>
</tr>
<tr>
<td style="text-align:left"><strong>components</strong></td>
<td style="text-align:left">service的组件列表</td>
<td style="text-align:left">&lt; check out HDFS metainfo&gt;</td>
</tr>
<tr>
<td style="text-align:left"><strong>osSpecifics</strong></td>
<td style="text-align:left">指定service运行所需的操作系统</td>
<td style="text-align:left">&lt; check out HDFS metainfo&gt;</td>
</tr>
<tr>
<td style="text-align:left"><em>commandScript</em></td>
<td style="text-align:left">定义service check脚本</td>
<td style="text-align:left">&lt; check out HDFS metainfo&gt;</td>
</tr>
<tr>
<td style="text-align:left"><em>comment</em></td>
<td style="text-align:left">service的简短描述</td>
<td style="text-align:left">Apache Hadoop Distributed File System</td>
</tr>
<tr>
<td style="text-align:left"><em>requiredServices</em></td>
<td style="text-align:left">该服务所需的前置服务</td>
<td style="text-align:left">&lt; check out HDFS metainfo&gt;</td>
</tr>
<tr>
<td style="text-align:left"><em>configuration-dependencies</em></td>
<td style="text-align:left">service所需的其他配置文件（这些配置文件本身属于其他service）</td>
<td style="text-align:left">&lt; check out HDFS metainfo&gt;</td>
</tr>
<tr>
<td style="text-align:left"><em>restartRequiredAfterRackChange</em></td>
<td style="text-align:left">Rack变更后是否必须重启</td>
<td style="text-align:left">true / false</td>
</tr>
<tr>
<td style="text-align:left"><em>configuration-dir</em></td>
<td style="text-align:left">如果配置目录不是默认的configuration，则需要使用该项来指定</td>
<td style="text-align:left">-</td>
</tr>
</tbody>
</table>
<h3 id="service-components-一个service包含多个components。与component有关的字段有："><a href="#service-components-一个service包含多个components。与component有关的字段有：" class="headerlink" title="service/components - 一个service包含多个components。与component有关的字段有："></a>service/components - 一个service包含多个components。与component有关的字段有：</h3><table>
<thead>
<tr>
<th style="text-align:left">Field</th>
<th style="text-align:left">What is it used it</th>
<th style="text-align:left">Sample Values</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>name</strong></td>
<td style="text-align:left">component的名字。</td>
<td style="text-align:left">NameNode</td>
</tr>
<tr>
<td style="text-align:left"><strong>dsplayName</strong></td>
<td style="text-align:left">component的显示名。</td>
<td style="text-align:left">NameNode</td>
</tr>
<tr>
<td style="text-align:left"><strong>category</strong></td>
<td style="text-align:left">component的类型。可选值为MASTER、SLAVE或CLIENT。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left"><strong>commandScript</strong></td>
<td style="text-align:left">应用的命令。</td>
<td style="text-align:left">&lt; check out HDFS metainfo&gt;</td>
</tr>
<tr>
<td style="text-align:left"><em>cardinality</em></td>
<td style="text-align:left">允许的实例个数。</td>
<td style="text-align:left">MASTER一般设置为1-2， SLAVE一般设置为1+</td>
</tr>
<tr>
<td style="text-align:left"><em>reassignAllowed</em></td>
<td style="text-align:left">是否允许component被重新分配或移动到另外的主机。</td>
<td style="text-align:left">true / false</td>
</tr>
<tr>
<td style="text-align:left"><em>versionAdvertised</em></td>
<td style="text-align:left">component是否显示它的版本信息。回滚/升级时使用。</td>
<td style="text-align:left">true / false</td>
</tr>
<tr>
<td style="text-align:left"><em>timelineAppid</em></td>
<td style="text-align:left">metrics收集时用来进行区分的id。</td>
<td style="text-align:left">HDFS</td>
</tr>
<tr>
<td style="text-align:left"><em>dependencies</em></td>
<td style="text-align:left">component所依赖的其他component列表。</td>
<td style="text-align:left">&lt; check out HDFS metainfo&gt;</td>
</tr>
<tr>
<td style="text-align:left"><em>customCommands</em></td>
<td style="text-align:left">组件的自定义命令，有别与标准命令。</td>
<td style="text-align:left">RESTART_LLAP (Check out HIVE metainfo)</td>
</tr>
</tbody>
</table>
<h3 id="service-osSpecifics-操作系统包的名"><a href="#service-osSpecifics-操作系统包的名" class="headerlink" title="service/osSpecifics - 操作系统包的名"></a>service/osSpecifics - 操作系统包的名</h3><table>
<thead>
<tr>
<th style="text-align:left">Field</th>
<th style="text-align:left">What is it used for</th>
<th style="text-align:left">Sample Values</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>osFamily</strong></td>
<td style="text-align:left">service对应的操作系统</td>
<td style="text-align:left">any =&gt; all， amazon2015、redhat6、debian7</td>
</tr>
<tr>
<td style="text-align:left"><strong>packages</strong></td>
<td style="text-align:left">部署这个service所需的packages列表</td>
<td style="text-align:left">&lt; check out HDFS metainfo&gt;</td>
</tr>
<tr>
<td style="text-align:left"><strong>package/name</strong></td>
<td style="text-align:left">package的名字(会被yum\apt等命令使用)</td>
<td style="text-align:left">如 hadoop-lzo</td>
</tr>
</tbody>
</table>
<h3 id="service-commandScript-service检查的脚本"><a href="#service-commandScript-service检查的脚本" class="headerlink" title="service/commandScript - service检查的脚本"></a>service/commandScript - service检查的脚本</h3><table>
<thead>
<tr>
<th style="text-align:left">Field</th>
<th style="text-align:left">What is it used for</th>
<th style="text-align:left">Sample Values</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>script</strong></td>
<td style="text-align:left">脚本的相对路径</td>
<td style="text-align:left">scripts/service_check.py</td>
</tr>
<tr>
<td style="text-align:left"><strong>scriptType</strong></td>
<td style="text-align:left">脚本的类型，当前纸支持PYTHON</td>
<td style="text-align:left">PYTHON</td>
</tr>
<tr>
<td style="text-align:left"><strong>timeout</strong></td>
<td style="text-align:left">命令的超时时间</td>
<td style="text-align:left">300</td>
</tr>
</tbody>
</table>
<h3 id="service-component-customCommand-component的自定义命令"><a href="#service-component-customCommand-component的自定义命令" class="headerlink" title="service/component/customCommand - component的自定义命令"></a>service/component/customCommand - component的自定义命令</h3><blockquote>
<p><strong>name:</strong> 自定义命令的名字<br><strong>commandScript:</strong> 实现自定义命令的脚本信息，它包含其他片段。<br><strong>commandScript/script:</strong> 脚本的相对路径<br><strong>commandScript/scriptType:</strong> 脚本的类型，目前只支持PYTHON。<br><strong>commandScript/timeout:</strong> 命令的超时时间。</p>
</blockquote>
<h2 id="Sample-metainfo-xml"><a href="#Sample-metainfo-xml" class="headerlink" title="Sample metainfo.xml"></a>Sample metainfo.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">metainfo</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">schemaVersion</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">schemaVersion</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">services</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>HBASE<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">displayName</span>&gt;</span>HBase<span class="tag">&lt;/<span class="name">displayName</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">comment</span>&gt;</span>Non-relational distributed database and centralized service for configuration management &amp;amp;</div><div class="line"> synchronization</div><div class="line">      <span class="tag">&lt;/<span class="name">comment</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.96.0.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">components</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">component</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">name</span>&gt;</span>HBASE_MASTER<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">displayName</span>&gt;</span>HBase Master<span class="tag">&lt;/<span class="name">displayName</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">category</span>&gt;</span>MASTER<span class="tag">&lt;/<span class="name">category</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">cardinality</span>&gt;</span>1+<span class="tag">&lt;/<span class="name">cardinality</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">versionAdvertised</span>&gt;</span>true<span class="tag">&lt;/<span class="name">versionAdvertised</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">timelineAppid</span>&gt;</span>HBASE<span class="tag">&lt;/<span class="name">timelineAppid</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">name</span>&gt;</span>HDFS/HDFS_CLIENT<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">scope</span>&gt;</span>host<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">auto-deploy</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">auto-deploy</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">name</span>&gt;</span>ZOOKEEPER/ZOOKEEPER_SERVER<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">scope</span>&gt;</span>cluster<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">auto-deploy</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">co-locate</span>&gt;</span>HBASE/HBASE_MASTER<span class="tag">&lt;/<span class="name">co-locate</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">auto-deploy</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">commandScript</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">scripts/hbase_master.py</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scriptType</span>&gt;</span>PYTHON<span class="tag">&lt;/<span class="name">scriptType</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">timeout</span>&gt;</span>1200<span class="tag">&lt;/<span class="name">timeout</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">commandScript</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">customCommands</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">customCommand</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">name</span>&gt;</span>DECOMMISSION<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">commandScript</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">scripts/hbase_master.py</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">scriptType</span>&gt;</span>PYTHON<span class="tag">&lt;/<span class="name">scriptType</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">timeout</span>&gt;</span>600<span class="tag">&lt;/<span class="name">timeout</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">commandScript</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">customCommand</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">customCommands</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">component</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">component</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">name</span>&gt;</span>HBASE_REGIONSERVER<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">displayName</span>&gt;</span>RegionServer<span class="tag">&lt;/<span class="name">displayName</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">category</span>&gt;</span>SLAVE<span class="tag">&lt;/<span class="name">category</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">cardinality</span>&gt;</span>1+<span class="tag">&lt;/<span class="name">cardinality</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">versionAdvertised</span>&gt;</span>true<span class="tag">&lt;/<span class="name">versionAdvertised</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">timelineAppid</span>&gt;</span>HBASE<span class="tag">&lt;/<span class="name">timelineAppid</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">commandScript</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">scripts/hbase_regionserver.py</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scriptType</span>&gt;</span>PYTHON<span class="tag">&lt;/<span class="name">scriptType</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">commandScript</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">component</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">component</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">name</span>&gt;</span>HBASE_CLIENT<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">displayName</span>&gt;</span>HBase Client<span class="tag">&lt;/<span class="name">displayName</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">category</span>&gt;</span>CLIENT<span class="tag">&lt;/<span class="name">category</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">cardinality</span>&gt;</span>1+<span class="tag">&lt;/<span class="name">cardinality</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">versionAdvertised</span>&gt;</span>true<span class="tag">&lt;/<span class="name">versionAdvertised</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">commandScript</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">scripts/hbase_client.py</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">scriptType</span>&gt;</span>PYTHON<span class="tag">&lt;/<span class="name">scriptType</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">commandScript</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">configFiles</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configFile</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">type</span>&gt;</span>xml<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">fileName</span>&gt;</span>hbase-site.xml<span class="tag">&lt;/<span class="name">fileName</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">dictionaryName</span>&gt;</span>hbase-site<span class="tag">&lt;/<span class="name">dictionaryName</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configFile</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">configFile</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">type</span>&gt;</span>env<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">fileName</span>&gt;</span>hbase-env.sh<span class="tag">&lt;/<span class="name">fileName</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">dictionaryName</span>&gt;</span>hbase-env<span class="tag">&lt;/<span class="name">dictionaryName</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">configFile</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">configFiles</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">component</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">components</span>&gt;</span></div><div class="line"></div><div class="line">      <span class="tag">&lt;<span class="name">osSpecifics</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">osSpecific</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">osFamily</span>&gt;</span>any<span class="tag">&lt;/<span class="name">osFamily</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">packages</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">package</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">package</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">packages</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">osSpecific</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">osSpecifics</span>&gt;</span></div><div class="line"></div><div class="line">      <span class="tag">&lt;<span class="name">commandScript</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">scripts/service_check.py</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">scriptType</span>&gt;</span>PYTHON<span class="tag">&lt;/<span class="name">scriptType</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">timeout</span>&gt;</span>300<span class="tag">&lt;/<span class="name">timeout</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">commandScript</span>&gt;</span></div><div class="line">      </div><div class="line">      <span class="tag">&lt;<span class="name">requiredServices</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">service</span>&gt;</span>ZOOKEEPER<span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">service</span>&gt;</span>HDFS<span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">requiredServices</span>&gt;</span></div><div class="line"></div><div class="line">      <span class="tag">&lt;<span class="name">configuration-dependencies</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">config-type</span>&gt;</span>core-site<span class="tag">&lt;/<span class="name">config-type</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">config-type</span>&gt;</span>hbase-site<span class="tag">&lt;/<span class="name">config-type</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">config-type</span>&gt;</span>ranger-hbase-policymgr-ssl<span class="tag">&lt;/<span class="name">config-type</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">config-type</span>&gt;</span>ranger-hbase-security<span class="tag">&lt;/<span class="name">config-type</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">configuration-dependencies</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">services</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">metainfo</span>&gt;</span></div></pre></td></tr></table></figure>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/Ambari/" rel="tag">#Ambari</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2018/08/13/ambari/" rel="next" title="Ambari">
                <i class="fa fa-chevron-left"></i> Ambari
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2018/09/04/ambari-resource/" rel="prev" title="Ambari Resource 01">
                Ambari Resource 01 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/blog/uploads/avatar.png"
               alt="baimoon" />
          <p class="site-author-name" itemprop="name">baimoon</p>
          <p class="site-description motion-element" itemprop="description">Baimoon's blog</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/blog/archives">
              <span class="site-state-item-count">52</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/blog/categories">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/blog/tags">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/baimoon" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://gallery.xrange.org" title="xrange" target="_blank">xrange</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Stacks-and-Services"><span class="nav-number">1.</span> <span class="nav-text">Stacks and Services</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Terminology"><span class="nav-number">1.2.</span> <span class="nav-text">Terminology</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Overview"><span class="nav-number">2.</span> <span class="nav-text">Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Background"><span class="nav-number">2.1.</span> <span class="nav-text">Background</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Structure"><span class="nav-number">2.2.</span> <span class="nav-text">Structure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Defining-a-Service-and-Components"><span class="nav-number">2.3.</span> <span class="nav-text">Defining a Service and Components</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Using-Stack-Inheritance"><span class="nav-number">2.4.</span> <span class="nav-text">Using Stack Inheritance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Example-Implementing-a-Custom-Service"><span class="nav-number">2.5.</span> <span class="nav-text">Example: Implementing a Custom Service</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-and-Add-the-Service"><span class="nav-number">2.5.1.</span> <span class="nav-text">Create and Add the Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-the-Service-Via-Ambari-WEb-“Add-Service”"><span class="nav-number">2.5.2.</span> <span class="nav-text">Install the Service(Via Ambari WEb “Add Service”)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Example-Implementing-a-Custom-Client-only-Service"><span class="nav-number">2.6.</span> <span class="nav-text">Example: Implementing a Custom Client-only Service</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-and-Add-the-Service-1"><span class="nav-number">2.6.1.</span> <span class="nav-text">Create and Add the Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-the-Service-Via-the-Ambari-REST-API"><span class="nav-number">2.6.2.</span> <span class="nav-text">Install the Service(Via the Ambari REST API)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-the-Service-via-Ambari-Web-“Add-Services”"><span class="nav-number">2.6.3.</span> <span class="nav-text">Install the Service(via Ambari Web “Add Services”)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Example-Implementing-a-Custom-Client-only-Service-with-Configs"><span class="nav-number">2.7.</span> <span class="nav-text">Example: Implementing a Custom Client-only Service (with Configs)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-and-Add-the-Service-to-Stack"><span class="nav-number">2.7.1.</span> <span class="nav-text">Create and Add the Service to Stack</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-To-Define-Stacks-and-Services"><span class="nav-number">3.</span> <span class="nav-text">How-To Define  Stacks and Services</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Define-Service"><span class="nav-number">3.1.</span> <span class="nav-text">Define Service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#metainfo-xml"><span class="nav-number">3.2.</span> <span class="nav-text">metainfo.xml</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Scripts"><span class="nav-number">3.2.1.</span> <span class="nav-text">Scripts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python"><span class="nav-number">3.2.2.</span> <span class="nav-text">Python</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#OS-Variant-Script"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">OS Variant Script</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Actions"><span class="nav-number">3.2.3.</span> <span class="nav-text">Custom Actions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Stack-Changes"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">Stack Changes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UI-Changes"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">UI Changes</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Configuration"><span class="nav-number">3.3.</span> <span class="nav-text">Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Adding-new-configs-in-a-config-type"><span class="nav-number">3.3.1.</span> <span class="nav-text">Adding new configs in a config-type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UI-Categories"><span class="nav-number">3.3.2.</span> <span class="nav-text">UI - Categories</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UI-Enhanced-Configs"><span class="nav-number">3.3.3.</span> <span class="nav-text">UI - Enhanced Configs</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Alerts"><span class="nav-number">3.4.</span> <span class="nav-text">Alerts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kerberos"><span class="nav-number">3.5.</span> <span class="nav-text">Kerberos</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Metrics"><span class="nav-number">3.6.</span> <span class="nav-text">Metrics</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Quick-Links"><span class="nav-number">3.7.</span> <span class="nav-text">Quick Links</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Widgets"><span class="nav-number">3.8.</span> <span class="nav-text">Widgets</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Role-Command-Order"><span class="nav-number">3.9.</span> <span class="nav-text">Role Command Order</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-Advisor"><span class="nav-number">3.10.</span> <span class="nav-text">Service Advisor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Examples"><span class="nav-number">3.10.1.</span> <span class="nav-text">Examples</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-Upgrade"><span class="nav-number">3.11.</span> <span class="nav-text">Service Upgrade</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Examples-1"><span class="nav-number">3.11.1.</span> <span class="nav-text">Examples</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Define-Stack"><span class="nav-number">4.</span> <span class="nav-text">Define Stack</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Stack-Version-Descriptor"><span class="nav-number">4.1.</span> <span class="nav-text">Stack-Version Descriptor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Stack-Properties"><span class="nav-number">4.2.</span> <span class="nav-text">Stack Properties</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Services"><span class="nav-number">4.3.</span> <span class="nav-text">Services</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference-common-services"><span class="nav-number">4.3.1.</span> <span class="nav-text">Reference common-services</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Define-Service-1"><span class="nav-number">4.3.2.</span> <span class="nav-text">Define Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Extend-Service"><span class="nav-number">4.3.3.</span> <span class="nav-text">Extend Service</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Role-Command-Order-1"><span class="nav-number">4.4.</span> <span class="nav-text">Role Command Order</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Format"><span class="nav-number">4.4.1.</span> <span class="nav-text">Format</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sections"><span class="nav-number">4.4.2.</span> <span class="nav-text">Sections</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Commands"><span class="nav-number">4.4.3.</span> <span class="nav-text">Commands</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Examples-2"><span class="nav-number">4.4.4.</span> <span class="nav-text">Examples</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Repositories"><span class="nav-number">4.5.</span> <span class="nav-text">Repositories</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Latest-Builds"><span class="nav-number">4.5.1.</span> <span class="nav-text">Latest Builds</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hooks"><span class="nav-number">4.6.</span> <span class="nav-text">Hooks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Command-Sub-Folders"><span class="nav-number">4.6.1.</span> <span class="nav-text">Command Sub-Folders</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Configurations"><span class="nav-number">4.7.</span> <span class="nav-text">Configurations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Stack-Advisor"><span class="nav-number">4.7.1.</span> <span class="nav-text">Stack Advisor</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Examples-3"><span class="nav-number">4.7.1.1.</span> <span class="nav-text">Examples:</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Properties"><span class="nav-number">4.7.2.</span> <span class="nav-text">Properties</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Widgets-1"><span class="nav-number">4.7.3.</span> <span class="nav-text">Widgets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kerberos-1"><span class="nav-number">4.7.4.</span> <span class="nav-text">Kerberos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stack-Upgrades"><span class="nav-number">4.7.5.</span> <span class="nav-text">Stack Upgrades</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Writing-metainfo-xml"><span class="nav-number">5.</span> <span class="nav-text">Writing metainfo.xml</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Structure-1"><span class="nav-number">5.1.</span> <span class="nav-text">Structure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#service-components-一个service包含多个components。与component有关的字段有："><span class="nav-number">5.1.1.</span> <span class="nav-text">service/components - 一个service包含多个components。与component有关的字段有：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#service-osSpecifics-操作系统包的名"><span class="nav-number">5.1.2.</span> <span class="nav-text">service/osSpecifics - 操作系统包的名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#service-commandScript-service检查的脚本"><span class="nav-number">5.1.3.</span> <span class="nav-text">service/commandScript - service检查的脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#service-component-customCommand-component的自定义命令"><span class="nav-number">5.1.4.</span> <span class="nav-text">service/component/customCommand - component的自定义命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sample-metainfo-xml"><span class="nav-number">5.2.</span> <span class="nav-text">Sample metainfo.xml</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016-07 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">baimoon</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/blog/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/blog/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/blog/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/blog/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
